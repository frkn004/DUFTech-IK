<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DUF Tech M√ºlakat Asistanƒ±</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='duftech-logo-final.svg') }}">
    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
            color: #1a202c;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            padding: 1rem;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 50;
        }

        .chat-container {
            width: 100%;
            max-width: 1200px;
            height: 100vh;
            margin: 0 auto;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .duftech-logo {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 180px;
            height: auto;
            z-index: 100;
            filter: drop-shadow(0 2px 5px rgba(0, 0, 0, 0.1));
            transition: all 0.3s ease;
        }

        .duftech-logo:hover {
            transform: scale(1.05);
        }

        .duftech-avatar {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            transition: all 0.3s ease;
        }

        .duftech-avatar i {
            font-size: 24px;
            color: #ffffff;
            transition: all 0.3s ease;
        }

        /* Robot Animasyonlarƒ± */
        .duftech-avatar.speaking {
            background: linear-gradient(135deg, #00CED1 0%, #008B8B 100%);
            box-shadow: 0 0 15px rgba(0, 206, 209, 0.6);
        }

        .duftech-avatar.speaking i {
            color: #ffffff;
            animation: pulse 1.5s infinite;
        }

        .duftech-avatar.listening {
            background: linear-gradient(135deg, #C8A2C8 0%, #9370DB 100%);
            box-shadow: 0 0 15px rgba(147, 112, 219, 0.6);
        }

        .duftech-avatar.listening i {
            color: #ffffff;
            animation: wave 1.5s infinite;
        }

        .duftech-avatar.idle {
            background: #f0f0f0;
        }

        .duftech-avatar.idle i {
            color: #444444;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes wave {
            0% { transform: rotate(0deg); }
            50% { transform: rotate(180deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal Styles - temaya uygun hale getirildi */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(200, 162, 200, 0.2);
        }

        .modal-header {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
            color: #00CED1;
            text-align: center;
            border-bottom: 2px solid rgba(0, 206, 209, 0.2);
            padding-bottom: 0.75rem;
        }

        .modal-body {
            margin-bottom: 1.5rem;
        }

        .modal-footer {
            text-align: center;
            margin-top: 2rem;
        }

        .modal-button {
            background: linear-gradient(135deg, #00CED1 0%, #008B8B 100%);
            color: white;
            padding: 0.75rem 2rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .modal-button:hover {
            background: linear-gradient(135deg, #008B8B 0%, #006666 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 206, 209, 0.3);
        }
        
        /* Butonlarƒ±n yeni stili */
        .mode-buttons-container {
            position: fixed;
            bottom: 30px;
            left: 30px;
            display: flex;
            gap: 15px;
            z-index: 20;
        }
        
        .mode-toggle-button {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            font-weight: 500;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 20;
            background: linear-gradient(135deg, #00CED1 0%, #008B8B 100%);
            color: white;
            border: none;
        }
        
        .mode-toggle-button.manual {
            background: linear-gradient(135deg, #ff9a00 0%, #ff6a00 100%);
        }
        
        .end-button {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            font-weight: 500;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 20;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
        }
        
        .mode-toggle-button i,
        .end-button i {
            margin-right: 0.5rem;
            font-size: 1.1rem;
        }
        
        .mode-toggle-button:hover,
        .end-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }
        
        .report-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            background-image: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            cursor: pointer;
            text-decoration: none;
        }
        
        .report-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(16, 185, 129, 0.3);
        }
        
        .report-button i {
            margin-right: 0.5rem;
        }
        
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        .start-button {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            padding: 0.85rem 2rem;
            border-radius: 50px;
            font-weight: 600;
            font-size: 1.1rem;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 20;
            background: linear-gradient(135deg, #00CED1 0%, #008B8B 100%);
            color: white;
            border: none;
        }
        
        .start-button:hover {
            transform: translateX(-50%) translateY(-5px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.2);
        }
        
        .start-button i {
            margin-right: 0.75rem;
            font-size: 1.2rem;
        }
        
        .mode-info {
            position: fixed;
            bottom: 90px;
            left: 30px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            border-radius: 12px;
            padding: 12px 16px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            max-width: 400px;
            border: 1px solid rgba(200, 162, 200, 0.3);
            z-index: 19;
        }
        
        .mode-info p {
            display: flex;
            align-items: center;
        }
        
        .mode-info i {
            color: #00CED1;
            margin-right: 8px;
        }
        
        .hidden {
            display: none !important;
        }

        .chat-messages {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        .chat-bubble {
            position: fixed;
            max-width: 400px;
            padding: 1.5rem;
            border-radius: 20px;
            background: white;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            pointer-events: auto;
            opacity: 0;
            transform: scale(0.8) translateY(20px);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .chat-bubble.active {
            opacity: 1;
            transform: scale(1) translateY(0);
        }

        .chat-bubble.fade-out {
            opacity: 0;
            transform: scale(0.9) translateY(-20px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .assistant-bubble {
            left: 60%;
            top: 30%;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .user-bubble {
            right: 60%;
            top: 60%;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .message-content {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .message-icon {
            flex-shrink: 0;
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
        }

        .assistant-bubble .message-icon {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .user-bubble .message-icon {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .message-text {
            flex-grow: 1;
            font-size: 1rem;
            line-height: 1.5;
        }

        .status-indicator {
            position: fixed;
            bottom: 80px;
            left: 20px;
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 1.1rem;
            font-weight: 500;
            color: #4f46e5;
            transition: all 0.3s ease;
            white-space: nowrap;
            z-index: 11;
            min-width: 250px;
        }

        .status-indicator i {
            font-size: 1.4rem;
        }

        .status-indicator.speaking {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            animation: status-pulse 2s infinite;
        }

        .status-indicator.listening {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            animation: status-pulse 1s infinite;
        }

        .status-indicator.processing {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
            animation: status-pulse 0.5s infinite;
        }

        .status-indicator.idle {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
        }

        @keyframes status-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .auto-mode .status-indicator {
            background: #4f46e5;
            color: white;
        }

        .auto-mode-indicator {
            display: inline-flex;
            align-items: center;
            margin-left: 0.5rem;
            animation: pulse 2s infinite;
        }

        .volume-waves {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            pointer-events: none;
        }

        .volume-waves::before,
        .volume-waves::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(79, 70, 229, 0.2);
            animation: waves 2s infinite;
        }

        .volume-waves::after {
            animation-delay: 1s;
        }

        @keyframes waves {
            0% {
                transform: scale(1);
                opacity: 0.5;
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }

        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .completed {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        }
        
        .paused {
            opacity: 0.7;
        }

        /* Mod Durumu Bilgisi i√ßin stil */
        #modStatusBar {
            display: none;
            font-size: 0.95rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        /* Kamera yeniden konumlandƒ±rƒ±ldƒ± ve boyutu k√º√ß√ºlt√ºld√º */
        .camera-container {
            position: fixed;
            top: 150px; /* Daha a≈üaƒüƒ±da */
            right: 35px; /* Daha saƒüda */
            width: 160px;
            height: 120px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
            z-index: 40;
            display: block;
        }

        /* Header, kamera ve mod bilgisi i√ßin ayarlamalar */
        .header {
            top: 36px; /* Mod bilgi √ßubuƒüunun altƒ±na */
        }
        
        /* Mod Durumu Bilgisi i√ßin stil */
        #modStatusBar {
            display: none;
            font-size: 0.95rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        /* Manuel mod i√ßin g√º√ßlendirilmi≈ü stiller */
        .recording-active .status-indicator {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            animation: status-pulse 0.5s infinite;
            font-weight: bold;
        }
        
        .mode-toggle-button.active {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.4);
            transform: scale(1.05);
        }
        
        .record-indicator {
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Manuel mod g√∂stergesini daha belirgin hale getir */
        #manualModeStatus {
            padding: 4px 8px;
            border-radius: 6px;
            background-color: rgba(255, 106, 0, 0.15);
        }
        
        /* Space tu≈üu vurgusu */
        .keyboard-key {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: #fff;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: #333;
            padding: 2px 8px;
            font-size: 0.85em;
            font-weight: 600;
            box-shadow: 0 2px 0 rgba(0, 0, 0, 0.1);
            text-transform: uppercase;
            margin: 0 4px;
        }
        
        /* Kayƒ±t aktif olduƒüunda g√∂rsel uyarƒ± */
        .recording-active .record-indicator {
            animation: pulse 1s infinite;
            color: #ef4444;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .recording-active #statusText {
            color: #ef4444;
            font-weight: bold;
        }
        
        .recording-active #statusDot {
            background-color: #ef4444 !important;
            animation: pulseDot 1s infinite;
        }
        
        @keyframes pulseDot {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        /* Manuel mod butonu aktif olduƒüunda daha belirgin g√∂r√ºn√ºm */
        #manualModeButton.active {
            background: linear-gradient(135deg, #ff9500 0%, #ff7800 100%);
            box-shadow: 0 0 15px rgba(255, 149, 0, 0.5);
            transform: scale(1.05);
        }
        
        /* Otomatik mod butonu aktif olduƒüunda daha belirgin g√∂r√ºn√ºm */
        #autoModeButton.active {
            background: linear-gradient(135deg, #00CED1 0%, #008B8B 100%);
            box-shadow: 0 0 15px rgba(0, 206, 209, 0.5);
            transform: scale(1.05);
        }
        
        /* Manuel mod info paneli daha belirgin */
        #manualModeInfo {
            background-color: rgba(255, 149, 0, 0.1);
            border-left: 3px solid #ff9500;
            padding-left: 1rem;
        }
        
        /* Otomatik mod info paneli daha belirgin */
        #autoModeInfo {
            background-color: rgba(0, 206, 209, 0.1);
            border-left: 3px solid #00CED1;
            padding-left: 1rem;
        }

        /* Manuel kayƒ±t i√ßin g√∂rsel geri bildirim stilleri */
        .recording-active .record-indicator {
            animation: pulse 1.5s infinite;
            background-color: #ef4444 !important;
        }
        
        #statusText.recording {
            color: #ef4444;
            font-weight: bold;
        }
        
        #statusDot.recording {
            background-color: #ef4444;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        #manualModeButton.recording-active {
            background: linear-gradient(135deg, #ef4444 0%, #f97316 100%);
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }
        
        /* Manuel mod panel arka planƒ± */
        #manualModeInfo {
            background-color: rgba(254, 242, 242, 0.8);
            border: 1px solid #ef4444;
            border-radius: 10px;
            padding: 10px 15px;
        }
        
        /* Otomatik mod panel arka planƒ± */
        #autoModeInfo {
            background-color: rgba(236, 254, 255, 0.8);
            border: 1px solid #0891b2;
            border-radius: 10px;
            padding: 10px 15px;
        }
        
        /* Kayƒ±t durumunu g√∂steren daire (ortadaki animasyon i√ßin) */
        .record-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: rgba(239, 68, 68, 0.5);
            display: none;
            z-index: 100;
        }
        
        .recording-active .record-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .record-indicator:after {
            content: "üé§";
            font-size: 32px;
        }

        /* Manuel mod g√∂rsel geri bildirimleri */
        .record-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: rgba(239, 68, 68, 0.2);
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.3);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            pointer-events: none;
        }
        
        .recording-active .record-indicator {
            display: flex;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 0.7; }
            50% { transform: translate(-50%, -50%) scale(1.05); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0.7; }
        }
        
        /* Mod butonlarƒ± i√ßin animasyonlar */
        #manualModeButton.recording-active {
            background: linear-gradient(135deg, #ef4444 0%, #f97316 100%) !important;
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.5) !important;
        }
        
        /* Manuel mod i√ßin g√ºlen y√ºz animasyonu */
        .smile-animation {
            animation: bounce 1s infinite;
            font-size: 40px;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        /* Status dot animasyonu */
        #statusDot.recording {
            animation: blink 1s infinite;
            background-color: #ef4444 !important;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <!-- DUF Tech Logo -->
    <img src="{{ url_for('static', filename='duftech-interlocked-3d.svg') }}" alt="DUF Tech Logo" class="duftech-logo">

    <!-- DUF Tech Avatar -->
    <div class="duftech-avatar" id="duftechAvatar">
        <i class="fas fa-robot"></i>
    </div>

    <!-- Bilgilendirme Modal -->
    <div id="infoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                M√ºlakat Bilgilendirmesi
            </div>
            <div class="modal-body">
                <div class="space-y-4">
                    <div class="bg-teal-50 p-4 rounded-lg border border-teal-200">
                        <p class="text-teal-800 font-semibold mb-2">‚ö†Ô∏è √ñnemli Not:</p>
                        <p class="text-teal-700">Bu uygulama en iyi Google Chrome tarayƒ±cƒ±sƒ±nda √ßalƒ±≈ümaktadƒ±r. L√ºtfen Chrome kullanƒ±nƒ±z.</p>
                    </div>

                    <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                        <p class="text-purple-800 font-semibold mb-2">üéØ M√ºlakat Modlarƒ±:</p>
                        <div class="space-y-2">
                            <p class="flex items-center text-purple-700">
                                <i class="fas fa-microphone-alt mr-2"></i>
                                <strong>Otomatik Mod:</strong> Sesiniz algƒ±landƒ±ƒüƒ±nda otomatik kayƒ±t ba≈ülar ve durur
                            </p>
                            <p class="flex items-center text-purple-700">
                                <i class="fas fa-hand mr-2"></i>
                                <strong>Manuel Mod:</strong> Space tu≈üuna basƒ±lƒ± tutarak konu≈üabilirsiniz
                            </p>
                        </div>
                    </div>

                    <div class="bg-teal-50 p-4 rounded-lg border border-teal-200">
                        <p class="text-teal-800 font-semibold mb-2">‚úÖ Ba≈ülarken:</p>
                        <ul class="list-disc ml-6 space-y-2 text-teal-700">
                            <li>"M√ºlakata Ba≈üla" butonuna tƒ±klayƒ±n</li>
                            <li>Mod butonuna tekrar tƒ±klayarak otomatik/manuel arasƒ±nda ge√ßi≈ü yapabilirsiniz</li>
                            <li>GPT'nin konu≈ümasƒ± bitene kadar bekleyin</li>
                            <li>Net ve anla≈üƒ±lƒ±r konu≈üun</li>
                            <li>Cevaplarƒ±nƒ±zƒ± √ßok geciktirmeyin</li>
                        </ul>
                    </div>

                    <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                        <p class="text-purple-800 font-semibold mb-2">‚ùå Dikkat Edilmesi Gerekenler:</p>
                        <ul class="list-disc ml-6 space-y-2 text-purple-700">
                            <li>Mikrofon izni vermeyi unutmayƒ±n</li>
                            <li>G√ºr√ºlt√ºl√º ortamlardan ka√ßƒ±nƒ±n</li>
                            <li>Sistem sizi anlamadƒ±ƒüƒ±nda tekrar deneyin</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-button" onclick="closeModal()">Anladƒ±m, Ba≈üla</button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <div class="header">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">{{ interview.candidate_name }}</h1>
                    <p class="text-gray-600">{{ interview.position }}</p>
                </div>
                <div class="text-right">
                    <p class="text-sm text-gray-500">M√ºlakat Kodu: {{ interview.code }}</p>
                    <p class="text-xs text-gray-500">{{ interview.created_at }}</p>
                </div>
            </div>
        </div>
    </div>

    <div class="chat-container">
        <!-- Chat Messages -->
        <div id="messages" class="chat-messages"></div>
    </div>

    <!-- Kamera G√∂r√ºnt√ºs√º -->
    <div class="camera-container" id="cameraContainer">
        <video id="videoElement" autoplay playsinline></video>
        <canvas id="photoCanvas" style="display:none;"></canvas>
        <div class="camera-overlay" id="cameraOverlay">
            <div class="photo-flash" id="photoFlash"></div>
        </div>
    </div>

    <!-- Durum G√∂stergesi -->
    <div class="status-indicator">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">Dinlemeye hazƒ±r</span>
    </div>

    <!-- S√ºre Sayacƒ± -->
    <div class="timer">
        <i class="fas fa-clock"></i>
        <span id="interviewTimer">00:00</span>
    </div>

    <!-- Mod Durumu Bilgisi (DAHA YUKARI TA≈ûINDI) -->
    <div id="modStatusBar" class="fixed top-0 left-0 right-0 bg-gradient-to-r from-teal-500 to-purple-500 text-white py-2 px-4 text-center z-50">
        <div id="autoModeStatus" class="inline-block">
            <i class="fas fa-microphone-alt mr-2 animate-pulse"></i> 
            <b>Otomatik Mod:</b> Sesiniz algƒ±landƒ±ƒüƒ±nda kayƒ±t ba≈ülar ve sessizlikte otomatik durur
        </div>
        <div id="manualModeStatus" class="hidden inline-block">
            <i class="fas fa-hand mr-2"></i> 
            <b>Manuel Mod:</b> <span class="px-2 py-1 bg-white bg-opacity-20 rounded">Space</span> tu≈üuna basƒ±lƒ± tutarak konu≈üun
        </div>
    </div>

    <!-- Butonlarƒ± yeniden d√ºzenle -->
    <div class="mode-buttons-container hidden" id="modeButtonsContainer">
        <button class="mode-toggle-button" id="toggleModeButton">
            <i class="fas fa-microphone-alt"></i>
        <span>Otomatik Mod</span>
    </button>

        <button class="end-button" id="endInterviewButton">
        <i class="fas fa-stop"></i>
        <span>M√ºlakatƒ± Bitir</span>
    </button>
    </div>

    <button class="start-button" id="startButton">
        <i class="fas fa-play"></i>
        <span>M√ºlakata Ba≈üla</span>
    </button>

    <!-- Eski mod info bile≈üeni gizlendi, yukarƒ±ya ta≈üƒ±ndƒ± -->
    <div id="modeInfo" class="mode-info hidden">
        <div id="autoModeInfo" class="hidden">
            <p><i class="fas fa-info-circle"></i> Otomatik Mod: Sesiniz algƒ±landƒ±ƒüƒ±nda kayƒ±t ba≈ülar ve sessizlikte otomatik durur.</p>
        </div>
        <div id="manualModeInfo" class="hidden">
            <p><i class="fas fa-info-circle"></i> Manuel Mod: <span class="keyboard-key">Space</span> tu≈üuna basƒ±lƒ± tutarak konu≈üun.</p>
        </div>
    </div>

    <script>
        // Mevcut deƒüi≈ükenler ve fonksiyonlarƒ± korumak i√ßin aynƒ± tanƒ±mlarƒ± tutuyoruz
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let audioContext = null;
        let analyser = null;
        let silenceStart = null;
        let silenceTimeout = null;
        let isAutoMode = true;
        let isGPTSpeaking = false;
        let audioStream = null;
        let isAudioInitialized = false;
        let isMediaRecorderReady = false;
        let startTime = null;
        let interviewEnded = false;
        let interviewCode = new URLSearchParams(window.location.search).get('code');
        let realtimeSession = null;
        let interviewStartTime = null;
        let timerInterval = null;
        let chatHistory = [];
        let videoStream = null;
        let cameraActive = false;
        let photoInterval = null;
        let lastPhotoTime = 0;
        let photoCounter = 0;

        // WebSocket yerine SSE kullanƒ±mƒ±
        async function initializeRealtimeSession() {
            try {
                console.log("Realtime oturum ba≈ülatƒ±lƒ±yor...");
                
                // Token al
                const response = await fetch('/get_interview_token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        code: interviewCode
                    })
                });

                const data = await response.json();
                if (!data.success) {
                    console.warn("Realtime token alƒ±namadƒ±:", data.error || "Bilinmeyen hata");
                    return false;
                }

                console.log("Realtime token alƒ±ndƒ±");
                
                // Token ve session ID'yi sakla
                localStorage.setItem('interview_token', data.token);
                localStorage.setItem('interview_session_id', data.session_id);

                // WebSocket desteƒüi varsa ve URL verilmi≈üse baƒülantƒ±yƒ± kur
                if ('WebSocket' in window && data.websocket_url) {
                    try {
                        realtimeSession = new WebSocket(data.websocket_url);
                        
                        realtimeSession.onopen = function() {
                            console.log("WebSocket baƒülantƒ±sƒ± a√ßƒ±ldƒ±");
                        };
                        
                        realtimeSession.onclose = function(event) {
                            console.log("WebSocket baƒülantƒ±sƒ± kapandƒ±", event.code, event.reason);
                        };
                        
                        realtimeSession.onerror = function(error) {
                            console.error("WebSocket hatasƒ±:", error);
                        };
                        
                        return true;
                    } catch (error) {
                        console.error("WebSocket baƒülantƒ± hatasƒ±:", error);
                        return false;
                    }
                } else {
                    console.warn("WebSocket desteklenmiyor veya websocket_url saƒülanmadƒ±");
                    return false;
                }
            } catch (error) {
                console.error("Realtime oturum ba≈ülatma hatasƒ±:", error);
                return false;
            }
        }

        async function sendAudioToRealtime(audioBlob) {
            if (!realtimeSession || realtimeSession.readyState !== WebSocket.OPEN) {
                console.log("Realtime baƒülantƒ±sƒ± aktif deƒüil, alternatif y√∂ntem kullanƒ±lƒ±yor");
                // WebSocket baƒülantƒ±sƒ± yoksa veya a√ßƒ±k deƒüilse normal HTTP isteƒüi kullan
                return await sendAudioToServer(audioBlob);
            }

            try {
                // Ses verisini base64'e √ßevir
                const reader = new FileReader();
                
                return new Promise((resolve, reject) => {
                    reader.onloadend = function() {
                        try {
                            const base64Audio = reader.result.split(',')[1];
                            
                            // WebSocket √ºzerinden g√∂nder
                            realtimeSession.send(JSON.stringify({
                                type: 'audio',
                                data: base64Audio
                            }));
                            
                            console.log("Ses WebSocket √ºzerinden g√∂nderildi");
                            resolve(true);
                        } catch (error) {
                            console.error("Base64 d√∂n√º≈ü√ºm hatasƒ±:", error);
                            reject(error);
                        }
                    };
                    
                    reader.onerror = function(error) {
                        console.error("FileReader hatasƒ±:", error);
                        reject(error);
                    };
                    
                    reader.readAsDataURL(audioBlob);
                });
            } catch (error) {
                console.error("WebSocket ses g√∂nderme hatasƒ±:", error);
                // Hata olursa normal HTTP isteƒüine geri d√∂n
                return await sendAudioToServer(audioBlob);
            }
        }

        // Sayfa y√ºklendiƒüinde
        document.addEventListener('DOMContentLoaded', async function() {
            console.log("DOMContentLoaded olayƒ± ba≈üladƒ±");
            
            // T√ºm fonksiyonlarƒ±n tanƒ±mlƒ± olup olmadƒ±ƒüƒ±nƒ± kontrol et
            const requiredFunctions = [
                'startRecording', 'stopRecording', 'processAudio',
                'updateAvatarState', 'showError', 'enableManualMode',
                'enableAutoMode', 'initAudio', 'startVoiceDetection'
            ];
            
            const missingFunctions = requiredFunctions.filter(fn => typeof window[fn] !== 'function');
            if (missingFunctions.length > 0) {
                console.error("Tanƒ±mlƒ± olmayan fonksiyonlar:", missingFunctions);
            } else {
                console.log("T√ºm gerekli fonksiyonlar tanƒ±mlƒ±");
            }
            
            // Web Speech API desteƒüini kontrol et
            if ('SpeechSynthesisUtterance' in window && 'speechSynthesis' in window) {
                console.log("Web Speech API destekleniyor");
                
                // Kullanƒ±labilir sesleri listele
                const voices = window.speechSynthesis.getVoices();
                console.log(`${voices.length} ses bulundu`);
            } else {
                console.warn("Web Speech API desteklenmiyor");
                showError("Tarayƒ±cƒ±nƒ±z ses sentezi √∂zelliƒüini desteklemiyor. Chrome kullanmanƒ±zƒ± √∂neririz.");
            }
            
            // Modal'ƒ± g√∂ster
            if (typeof showModal === 'function') {
                showModal();
            } else {
                // showModal fonksiyonu yoksa, direkt DOM manip√ºlasyonu ile g√∂ster
                const infoModal = document.getElementById('infoModal');
                if (infoModal) {
                    infoModal.style.display = 'flex';
                }
            }
            
            // Buton dinleyicilerini ayarla
            console.log("Buton dinleyicileri ayarlanƒ±yor...");
            
            // Manuel mod butonu
            const manualModeButton = document.getElementById('manualModeButton');
            if (manualModeButton) {
                manualModeButton.addEventListener('click', function() {
                    if (!interviewEnded) {
                        enableManualMode();
                    }
                });
            }

            // Otomatik mod butonu
            const autoModeButton = document.getElementById('autoModeButton');
            if (autoModeButton) {
                autoModeButton.addEventListener('click', function() {
                    if (!interviewEnded) {
                        enableAutoMode();
                    }
                });
            }
            
            // Kayƒ±t g√∂stergesi ortada dairesel animasyon i√ßin div ekle
            const recordIndicator = document.createElement('div');
            recordIndicator.className = 'record-indicator';
            recordIndicator.innerHTML = '<div class="smile-animation">üòä</div>';
            document.body.appendChild(recordIndicator);
            
            // Space tu≈üu olaylarƒ±nƒ± ekle
            document.addEventListener('keydown', function(event) {
                // Space tu≈üu kontrol√º ve manuel mod kontrol√º
                if (event.code === 'Space' && !isAutoMode && !interviewEnded) {
                    event.preventDefault(); // Sayfanƒ±n kaymasƒ±nƒ± engelle
                    
                    // GPT konu≈üuyorsa kayƒ±t yapmayƒ± engelle
                    if (isGPTSpeaking) {
                        showError('L√ºtfen GPT konu≈ümasƒ±nƒ±n bitmesini bekleyin');
                        return;
                    }
                    
                    // Zaten kayƒ±t yapƒ±lƒ±yorsa, tekrar ba≈ülatma
                    if (isRecording) {
                        console.log("Zaten kayƒ±t yapƒ±lƒ±yor, tekrar ba≈ülatma i≈ülemi atlandƒ±");
                        return;
                    }
                    
                    console.log("Space tu≈üuna basƒ±ldƒ± - Manuel kayƒ±t ba≈ülatƒ±lƒ±yor");
                    
                    // √ñnceki kaydƒ± temizle ve yeni kayƒ±t ba≈ülat
                    console.log("√ñnceki kayƒ±t durumu sƒ±fƒ±rlanƒ±yor...");
                    resetRecordingState();
                    
                    // Kayƒ±t durumunu g√ºncelle ve g√∂rsel geri bildirim g√∂ster
                    document.getElementById('statusText').textContent = "Ses Kaydediliyor...";
                    document.getElementById('statusDot').style.backgroundColor = '#ef4444'; // Kƒ±rmƒ±zƒ±
                    document.getElementById('manualModeButton').classList.add('recording-active');
                    document.body.classList.add('recording-active');
                    
                    // Ortadaki daire g√∂stergesini g√ºncelle
                    updateRecordingVisuals(true);
                    
                    // MediaRecorder yeni s√ºr√ºm√º ile ba≈ülat - k√º√ß√ºk bir gecikme ile (50ms)
                    setTimeout(function() {
                        try {
                            if (!isRecording) return; // Bu s√ºrede iptal edilmi≈üse √ßƒ±kƒ±≈ü yap
                            
                            startRecording();
                            updateAvatarState('listening');
                        } catch (err) {
                            console.error("Kayƒ±t ba≈ülatma hatasƒ±:", err);
                            resetRecordingState();
                            showError("Kayƒ±t ba≈ülatƒ±lamadƒ±");
                        }
                    }, 50);
                }
            });

            document.addEventListener('keyup', function(event) {
                if (event.code === 'Space' && !isAutoMode && !interviewEnded) {
                    event.preventDefault(); // Sayfanƒ±n kaymasƒ±nƒ± engelle
                    
                    // Kayƒ±t yapƒ±lmƒ±yorsa, durdurma i≈ülemini atla
                    if (!isRecording) {
                        console.log("Aktif kayƒ±t yok, durdurma i≈ülemi atlandƒ±");
                        return;
                    }
                    
                    console.log("Space tu≈üu bƒ±rakƒ±ldƒ± - Manuel kayƒ±t durduruluyor");
                    
                    // Durumu g√ºncelle ve g√∂rsel geri bildirimi kapat
                    document.getElementById('statusText').textContent = "Ses ƒ∞≈üleniyor...";
                    document.getElementById('statusDot').style.backgroundColor = '#6b7280'; // Gri
                    document.getElementById('manualModeButton').classList.remove('recording-active');
                    document.body.classList.remove('recording-active');
                    
                    // Ortadaki daire g√∂stergesini gizle
                    updateRecordingVisuals(false);
                    
                    // Kaydƒ± durdur ve i≈üle
                    try {
                        stopRecording();
                    } catch (err) {
                        console.error("Kayƒ±t durdurma hatasƒ±:", err);
                        resetRecordingState(); // Hata durumunda temizlik yap
                        showError("Kayƒ±t durdurulamadƒ±");
                    }
                }
            });
            
            console.log("Buton dinleyicileri ayarlandƒ±");
            
            // M√ºlakat kodunu URL'den al
            interviewCode = new URLSearchParams(window.location.search).get('code');
            if (!interviewCode) {
                console.error("M√ºlakat kodu URL'de bulunamadƒ±!");
                showError("Ge√ßersiz m√ºlakat kodu");
                return;
            }
            
            // Realtime oturumu ba≈ülat
            await initializeRealtimeSession();
            
            console.log("M√ºlakat ba≈ülatmaya hazƒ±r");
        });
        
        // Mod deƒüi≈ütirme fonksiyonu (Otomatik <-> Manuel arasƒ± ge√ßi≈ü)
        function toggleMode() {
            if (isGPTSpeaking) {
                showError('GPT konu≈üurken mod deƒüi≈ütirilemez');
                return;
            }
            
            // Ses kaydƒ±nƒ± sonlandƒ±r √∂nce
            if (isRecording) {
                stopRecording();
            }
            
            // Modu deƒüi≈ütir ve durumu kaydet
            isAutoMode = !isAutoMode;
            
            // Mod deƒüi≈üimini konsola logla
            console.log('Mod deƒüi≈ütirildi:', isAutoMode ? 'Otomatik Mod' : 'Manuel Mod (Space tu≈üu ile kaydet)');
            
            // Mod durumu barƒ±nƒ± g√ºncelle
            updateModeStatus();
            
            // Buton rengini ve i√ßeriƒüini g√ºncelle
            updateModeButton();
            
            // API modlarƒ±nƒ± g√ºncelle
            if (isAutoMode) {
                enableAutoMode();
            } else {
                enableManualMode();
            }
        }
        
        // Mod durumu bilgisini g√ºncelle
        function updateModeStatus() {
            const autoStatus = document.getElementById('autoModeStatus');
            const manualStatus = document.getElementById('manualModeStatus');
            
            if (autoStatus && manualStatus) {
                if (isAutoMode) {
                    autoStatus.classList.remove('hidden');
                    manualStatus.classList.add('hidden');
                    document.body.classList.remove('manual-mode');
                } else {
                    autoStatus.classList.add('hidden');
                    manualStatus.classList.remove('hidden');
                    document.body.classList.add('manual-mode');
                }
            }
        }
        
        // Mod deƒüi≈ütirme butonunu g√ºncelle
        function updateModeButton() {
            const toggleButton = getElement('toggleModeButton');
            
            if (toggleButton) {
                if (isAutoMode) {
                    toggleButton.innerHTML = '<i class="fas fa-microphone-alt"></i><span>Otomatik Mod</span>';
                    toggleButton.classList.remove('manual');
                } else {
                    toggleButton.innerHTML = '<i class="fas fa-hand"></i><span>Manuel Mod</span>';
                    toggleButton.classList.add('manual');
                }
            }
            
            // Eski butonlarƒ± da g√ºncelle
            updateLegacyButtons();
        }
        
        // Eski butonlarƒ± g√ºncelle
        function updateLegacyButtons() {
            const autoBtn = getElement('autoModeButton');
            const manualBtn = getElement('manualModeButton');
            
            if (autoBtn) autoBtn.classList.toggle('active', isAutoMode);
            if (manualBtn) manualBtn.classList.toggle('active', !isAutoMode);
        }
        
        // Otomatik modu etkinle≈ütir
        function enableAutoMode() {
            if (isGPTSpeaking) {
                showError('GPT konu≈üurken mod deƒüi≈ütirilemez');
                return;
            }
            
            // √ñnceki kayƒ±t durumunu temizle
            resetRecordingState();
            
            isAutoMode = true;
            console.log('Otomatik mod etkinle≈ütirildi');
            
            // Buton g√∂r√ºn√ºmlerini g√ºncelle
            const manualModeButton = document.getElementById('manualModeButton');
            const autoModeButton = document.getElementById('autoModeButton');
            
            manualModeButton.classList.remove('active');
            autoModeButton.classList.add('active');
            
            // Mod bilgilerini g√ºncelle
            document.getElementById('modeInfo').classList.remove('hidden');
            document.getElementById('manualModeInfo').classList.add('hidden');
            document.getElementById('autoModeInfo').classList.remove('hidden');
            
            updateStatus('Ses seviyeniz algƒ±landƒ±ƒüƒ±nda kayƒ±t ba≈ülar', 'auto');
            updateAvatarState('listening');
            
            // Ses algƒ±lamayƒ± ba≈ülat
            if (isAudioInitialized) {
                startVoiceDetection();
            } else {
                initAudio().then((initialized) => {
                    if (initialized) {
                        startVoiceDetection();
                    }
                });
            }
        }
        
        // Manuel modu etkinle≈ütir
        function enableManualMode() {
            if (isGPTSpeaking) {
                showError('GPT konu≈üurken mod deƒüi≈ütirilemez');
                return;
            }
            
            // √ñnceki kayƒ±t durumunu tamamen temizle
            resetRecordingState();
            
            isAutoMode = false;
            console.log('Manuel mod etkinle≈ütirildi');
            
            // Buton g√∂r√ºn√ºmlerini g√ºncelle
            const manualModeButton = document.getElementById('manualModeButton');
            const autoModeButton = document.getElementById('autoModeButton');
            
            autoModeButton.classList.remove('active');
            manualModeButton.classList.add('active');
            
            // Mod bilgilerini g√ºncelle
            document.getElementById('modeInfo').classList.remove('hidden');
            document.getElementById('manualModeInfo').classList.remove('hidden');
            document.getElementById('autoModeInfo').classList.add('hidden');
            
            updateStatus('Space tu≈üuna basƒ±lƒ± tutarak konu≈üun', 'manual');
            updateAvatarState('idle');
            
            // Manuel modda otomatik kayƒ±t durduruluyor
            if (isRecording) {
                stopRecording();
            }
        }
        
        // M√ºlakat ba≈ülatma fonksiyonu
        async function startInterview() {
            try {
                console.log("startInterview fonksiyonu ba≈ülatƒ±ldƒ±");
                
                // M√ºlakata ba≈üla butonu yerine mod butonlarƒ±nƒ± g√∂ster
                const startButton = getElement('startButton', ['modeButton']);
                const modeButtonsContainer = getElement('modeButtonsContainer');
                
                if (startButton && modeButtonsContainer) {
                    startButton.style.display = 'none';
                    modeButtonsContainer.classList.remove('hidden');
                } else {
                    console.error("startButton veya modeButtonsContainer bulunamadƒ±");
                    showError('Aray√ºz √∂ƒüesi eksik');
                    return;
                }
                
                // Mod durum barƒ±nƒ± g√∂ster - En √ºstte
                const modStatusBar = document.getElementById('modStatusBar');
                if (modStatusBar) {
                    modStatusBar.style.display = 'block';
                    
                    // Header pozisyonunu ayarla
                    const header = document.querySelector('.header');
                    if (header) {
                        header.style.top = '36px'; // Mod bilgi √ßubuƒüunun altƒ±
                    }
                }
                
                // Kamera konteynerini saƒü √ºste ta≈üƒ± 
                const cameraContainer = document.getElementById('cameraContainer');
                if (cameraContainer) {
                    cameraContainer.style.top = '150px'; // Daha a≈üaƒüƒ±da
                    cameraContainer.style.right = '35px'; // Daha saƒüda
                    cameraContainer.style.width = '160px';
                    cameraContainer.style.height = '120px';
                }
                
                // Mod bilgisi g√∂stergesini ayarla
                const modeInfo = getElement('modeInfo');
                const autoModeInfo = getElement('autoModeInfo');
                
                if (modeInfo) modeInfo.classList.remove('hidden');
                if (autoModeInfo) autoModeInfo.classList.remove('hidden');
                
                // Varsayƒ±lan olarak otomatik modu etkinle≈ütir
                const toggleBtn = getElement('toggleModeButton');
                if (toggleBtn) {
                    toggleBtn.innerHTML = '<i class="fas fa-microphone-alt"></i><span>Otomatik Mod</span>';
                    toggleBtn.classList.remove('manual');
                }
                isAutoMode = true;
                
                // Kayƒ±t izni iste
                console.log("Mikrofon eri≈üimi isteniyor...");
                
                try {
                    // Mikrofon eri≈üimini ba≈ülat
                    const initialized = await initAudio();
                    if (!initialized) {
                        showError('Mikrofon eri≈üimi saƒülanamadƒ±');
                        return;
                    }
                    
                    // M√ºlakat ba≈ülatma API'sini √ßaƒüƒ±r
                    const response = await fetch('/start_interview', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            code: interviewCode
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // M√ºlakat ba≈üarƒ±yla ba≈ülatƒ±ldƒ±
                        console.log("M√ºlakat ba≈üarƒ±yla ba≈ülatƒ±ldƒ±:", data);
                        createChatBubble('assistant', data.welcome_message);
                        
                        // Otomatik modu ba≈ülat
                        updateStatus('Ses seviyeniz algƒ±landƒ±ƒüƒ±nda kayƒ±t ba≈ülar', 'auto');
                        updateAvatarState('listening');
                        
                        // Ses algƒ±lamayƒ± ba≈ülat
                        startVoiceDetection();
                        
                        // M√ºlakat zamanƒ±nƒ± ba≈ülat
                        if (typeof startInterviewTimer === 'function') {
                            startInterviewTimer();
                        } else {
                            // Fallback: Timer y√∂netimi
                            interviewStartTime = new Date();
                            updateTimer();
                            timerInterval = setInterval(updateTimer, 1000);
                        }
                    } else {
                        showError(data.error || 'M√ºlakat ba≈ülatƒ±lamadƒ±');
                    }
                } catch (error) {
                    console.error('Mikrofon hatasƒ±:', error);
                    showError('Mikrofon eri≈üim izni verilmedi');
                }
            } catch (error) {
                console.error('M√ºlakat ba≈ülatma hatasƒ±:', error);
                showError('M√ºlakat ba≈ülatƒ±lamadƒ±');
            }
        }

        // Ses kaydƒ±nƒ± i≈üleme fonksiyonunu g√ºncelle
        async function processAudio(audioBlob) {
            try {
                console.log('Ses kaydƒ± i≈üleniyor, boyut:', audioBlob.size, 'bytes');
                
                // √ñnceki kullanƒ±cƒ± mesajƒ±nƒ± temizle
                const existingUserMessages = document.querySelectorAll('.chat-bubble.user-bubble');
                existingUserMessages.forEach(msg => {
                    msg.classList.add('fade-out');
                    setTimeout(() => msg.remove(), 300);
                });

                // ƒ∞≈üleme durumunu g√ºncelle
                updateStatus('Ses i≈üleniyor...', 'processing');
                updateAvatarState('processing');
                
                try {
                    // √ñnce realtime √ºzerinden g√∂ndermeyi dene
                await sendAudioToRealtime(audioBlob);
                } catch (error) {
                    console.error('Realtime baƒülantƒ±sƒ± ba≈üarƒ±sƒ±z:', error);
                    // Ba≈üarƒ±sƒ±z olursa HTTP isteƒüi ile g√∂nder
                    await sendAudioToServer(audioBlob);
                }
            } catch (error) {
                console.error('Ses i≈üleme hatasƒ±:', error);
                updateStatus('Bir hata olu≈ütu', 'error');
                updateAvatarState('idle');
            }
        }

        // Ses seviyesi e≈üikleri
        const SILENCE_THRESHOLD = 0.005;  // Sessizlik e≈üiƒüi (daha da d√º≈ü√ºk)
        const VOICE_THRESHOLD = 0.03;    // Konu≈üma ba≈ülangƒ±√ß e≈üiƒüi (daha d√º≈ü√ºk)
        const SILENCE_DURATION = 800;    // Sessizlik s√ºresi (ms) - daha kƒ±sa s√ºre
        const MIN_CONFIDENCE = 0.6;      // Minimum g√ºven skoru

        async function initAudio() {
            try {
                if (isAudioInitialized) {
                    console.log('Ses sistemi zaten ba≈ülatƒ±lmƒ±≈ü durumda');
                    return true;
                }
                
                console.log('Ses kayƒ±t sistemi ba≈ülatƒ±lƒ±yor...');
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    } 
                });
                
                // Ba≈üarƒ±lƒ± cihaz bilgilerini log'a yazdƒ±r
                const audioTracks = stream.getAudioTracks();
                if (audioTracks.length > 0) {
                    const settings = audioTracks[0].getSettings();
                    console.log('Mikrofon √∂zellikleri:', settings);
                    console.log('Mikrofon etiketi:', audioTracks[0].label);
                }
                
                audioStream = stream;
                
                // AudioContext'i ba≈ülat
                window.AudioContext = window.AudioContext || window.webkitAudioContext;
                audioContext = new AudioContext();
                
                // Ses i≈üleme sistemini kur
                const source = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 1024;
                analyser.smoothingTimeConstant = 0.3;
                source.connect(analyser);
                
                // MediaRecorder'ƒ± ayarla
                mediaRecorder = new MediaRecorder(stream, { 
                    mimeType: 'audio/webm;codecs=opus',
                    audioBitsPerSecond: 128000 
                });
                
                mediaRecorder.ondataavailable = function(event) {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = async function() {
                    console.log('MediaRecorder durduruldu, toplam chunk sayƒ±sƒ±:', audioChunks.length);
                    
                    if (audioChunks.length === 0) {
                        console.warn('Ses verisi bulunamadƒ±!');
                        updateStatus('Ses kaydedilemedi', 'error');
                        return;
                    }
                    
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    console.log('Ses kaydƒ± tamamlandƒ±, boyut:', audioBlob.size, 'bytes');
                    
                    // Boyutu logla
                    if (audioBlob.size < 1000) {
                        console.warn('Ses kaydƒ± √ßok k√º√ß√ºk, mikrofon √ßalƒ±≈ümƒ±yor olabilir!');
                    }
                    
                    if (!interviewEnded) {
                        await processAudio(audioBlob);
                    }
                };
                
                // Ses seviyesi kontrol√ºn√º ba≈ülat
                requestAnimationFrame(checkAudioLevel);
                
                isMediaRecorderReady = true;
                isAudioInitialized = true;
                console.log('Ses sistemi ba≈üarƒ±yla kuruldu');
                
                return true;
            } catch (error) {
                console.error('Ses sistemi ba≈ülatma hatasƒ±:', error);
                if (error.name === 'NotAllowedError') {
                    showError('Mikrofon izni verilmedi. L√ºtfen izin verin.');
                } else if (error.name === 'NotFoundError') {
                    showError('Mikrofon cihazƒ± bulunamadƒ±. L√ºtfen mikrofon baƒülantƒ±nƒ±zƒ± kontrol edin.');
                } else {
                    showError('Ses sistemi ba≈ülatƒ±lamadƒ±: ' + error.message);
                }
                return false;
            }
        }

        async function stopAudioSystem() {
            try {
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                }
                
                if (audioContext) {
                    await audioContext.suspend();
                }
                
                if (audioStream) {
                    audioStream.getTracks().forEach(track => track.stop());
                }
                
                isAudioInitialized = false;
            } catch (error) {
                console.error('Ses sistemi durdurma hatasƒ±:', error);
            }
        }

        function startVoiceDetection() {
            if (!analyser || !isAutoMode || interviewEnded) {
                console.log('Ses algƒ±lama ba≈ülatƒ±lamƒ±yor:', {
                    analyserExists: !!analyser,
                    isAutoMode,
                    interviewEnded
                });
                return;
            }

            if (isGPTSpeaking) {
                console.log('GPT konu≈üuyor, ses algƒ±lama erteleniyor');
                return;
            }
            
            console.log('Ses algƒ±lama ba≈ülatƒ±lƒ±yor...');
            // Ses algƒ±lama ba≈ülattƒ±ƒüƒ±mƒ±zƒ± kullanƒ±cƒ±ya bildir
            updateStatus('Dinleniyor...', 'listening');
            updateAvatarState('listening');
            
            // Otomatik modda iken ses seviyesi kontrol√º zaten yapƒ±lƒ±yor
            if (isAudioInitialized && mediaRecorder && mediaRecorder.state === 'inactive') {
                console.log('Ses seviyesi kontrol√º ve kayƒ±t sistemi hazƒ±r');
                    startRecording();
                } else {
                console.warn('MediaRecorder hazƒ±r deƒüil veya zaten kayƒ±tta');
            }
        }

        function updateVolumeIndicator(volume) {
            const volumeWaves = document.querySelector('.volume-waves');
            if (volumeWaves) {
                volumeWaves.style.opacity = volume;
            }
            
            const statusDot = document.getElementById('statusDot');
            if (statusDot) {
            if (volume > VOICE_THRESHOLD) {
                statusDot.style.backgroundColor = '#ef4444'; // Kƒ±rmƒ±zƒ±
            } else if (volume > SILENCE_THRESHOLD) {
                statusDot.style.backgroundColor = '#22c55e'; // Ye≈üil
            } else {
                statusDot.style.backgroundColor = '#6b7280'; // Gri
                }
            }
        }

        function toggleRecording() {
            if (!mediaRecorder) {
                initAudio().then((initialized) => {
                    if (initialized) {
                        isAutoMode = true;
                        startVoiceDetection();
                        updateStatus('Otomatik mod aktif', 'auto');
                    }
                });
                return;
            }

            if (isRecording) {
                stopRecording();
            } else {
                isAutoMode = true;
                startVoiceDetection();
                updateStatus('Otomatik mod aktif', 'auto');
            }
        }

        // Yeni bir MediaRecorder olu≈üturan ve kayƒ±t ba≈ülatan fonksiyon
        function _startRecordingInternal() {
            try {
                // Ses par√ßalarƒ±nƒ± tutacak array'i temizle
                audioChunks = [];
                
                // MediaRecorder ba≈ülatƒ±lƒ±yor
                console.log("MediaRecorder hazƒ±r, kayƒ±t ba≈ülatƒ±lƒ±yor");
                
                // MediaRecorder olu≈ütur
                mediaRecorder = new MediaRecorder(audioStream, {
                    mimeType: 'audio/webm;codecs=opus',
                    audioBitsPerSecond: 128000
                });
                
                // Ses verisi geldiƒüinde
                mediaRecorder.ondataavailable = function(event) {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                        console.log(`Ses chunk alƒ±ndƒ±, boyut: ${event.data.size} bytes`);
                    }
                };
                
                // Kayƒ±t durduƒüunda
                mediaRecorder.onstop = function() {
                    console.log(`MediaRecorder durduruldu, toplam chunk sayƒ±sƒ±: ${audioChunks.length}`);
                    
                    if (audioChunks.length === 0) {
                        console.warn("Ses verisi bulunamadƒ±!");
                        return;
                    }
                    
                    var audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    console.log(`Ses kaydƒ± tamamlandƒ±, boyut: ${audioBlob.size} bytes`);
                    
                    // Ses kaydƒ±nƒ± i≈üle
                    processAudio(audioBlob);
                };
                
                // Kayƒ±t ba≈ülat - Her 100ms'de bir veri al
                mediaRecorder.start(100);
                console.log("Kayƒ±t ba≈ülatƒ±ldƒ±");
                isRecording = true;
                
                // ƒ∞stenilen mod'a g√∂re UI'ƒ± g√ºncelle
                if (isAutoMode) {
                    document.getElementById('statusText').textContent = "Ses Algƒ±landƒ± (Otomatik Kayƒ±t)";
                } else {
                    document.getElementById('statusText').textContent = "Kaydediliyor... (Space tu≈üunu bƒ±rakƒ±nca kayƒ±t durur)";
                }
                
            } catch (error) {
                console.error("MediaRecorder hatasƒ±:", error);
                resetRecordingState();
                showError("Ses kaydƒ± ba≈ülatƒ±lamadƒ±: " + error.message);
            }
        }

        // startRecording fonksiyonunu g√ºncelle
        function startRecording() {
            if (isRecording) {
                console.log("Zaten kayƒ±t yapƒ±lƒ±yor, i≈ülem atlandƒ±");
                return;
            }
            
            if (!audioStream) {
                console.error("Ses akƒ±≈üƒ± (audioStream) bulunamadƒ±!");
                showError("Mikrofon baƒülantƒ±sƒ± kurulamadƒ±");
                return;
            }
            
            // Avatar durumunu g√ºncelle
            updateAvatarState('listening');
            
            // Kayƒ±t durumunu true olarak i≈üaretle ve kayƒ±t ba≈ülat
            isRecording = true;
            _startRecordingInternal();
            
            // G√∂rsel geribildirim
            document.body.classList.add('recording-active');
            if (!isAutoMode) {
                document.getElementById('statusDot').style.backgroundColor = '#ef4444'; // Kƒ±rmƒ±zƒ±
            }
        }

        // stopRecording fonksiyonunu g√ºncelle
        function stopRecording() {
            // Eƒüer kaydedilmiyor veya MediaRecorder hazƒ±r deƒüilse √ßƒ±k
            if (!isRecording || !mediaRecorder) {
                return;
            }
            
            // MediaRecorder durumunu kontrol et
            console.log("Kayƒ±t durdurma isteƒüi - Durum kontrol√º:", {
                isRecording: isRecording,
                mediaRecorderState: mediaRecorder ? mediaRecorder.state : 'unavailable'
            });
            
            try {
                // Eƒüer kayƒ±t aktifse, durdur
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    console.log("MediaRecorder aktif - durdurma √ßaƒürƒ±lƒ±yor");
                    mediaRecorder.stop();
                    console.log("Kayƒ±t durduruldu");
                } else {
                    console.log("MediaRecorder aktif deƒüil - durum sƒ±fƒ±rlanƒ±yor");
                }
            } catch (error) {
                console.error("Kayƒ±t durdurma hatasƒ±:", error);
            } finally {
                // Kayƒ±t durumunu false olarak i≈üaretle 
                isRecording = false;
                
                // UI g√ºncelle
                document.body.classList.remove('recording-active');
                updateAvatarState('processing');
            }
        }

        // Kayƒ±t durumunu tamamen sƒ±fƒ±rla
        function resetRecordingState() {
            console.log("Kayƒ±t durumu sƒ±fƒ±rlandƒ±");
            
            // Durum deƒüi≈ükenlerini sƒ±fƒ±rla
            isRecording = false;
            audioChunks = [];
            
            // MediaRecorder'ƒ± durdur
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                try {
                    mediaRecorder.stop();
                } catch (e) {
                    console.warn("MediaRecorder durdurma hatasƒ±:", e);
                }
            }
            
            // Ses algƒ±lama zamanlayƒ±cƒ±sƒ±nƒ± temizle
            if (silenceTimeout) {
                clearTimeout(silenceTimeout);
                silenceTimeout = null;
            }
            
            // UI'ƒ± sƒ±fƒ±rla
            document.body.classList.remove('recording-active');
        }

        // G√ºlen y√ºz emojisi i√ßeren dairenin g√∂r√ºn√ºm√ºn√º g√ºncelle
        function updateRecordingVisuals(isActive) {
            const recordIndicator = document.querySelector('.record-indicator');
            if (!recordIndicator) return;
            
            if (isActive) {
                recordIndicator.style.display = 'flex';
                recordIndicator.innerHTML = '<div style="font-size: 40px;">üòä</div>';
            } else {
                recordIndicator.style.display = 'none';
            }
        }

        function updateRecordingUI(isRecording) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            const avatar = document.getElementById('duftechAvatar');
            
            if (isRecording) {
                statusDot.classList.add('listening');
                statusText.textContent = 'Kaydediliyor...';
                avatar.classList.add('speaking');
            } else {
                statusDot.classList.remove('listening');
                statusText.textContent = isAutoMode ? 'Dinleniyor...' : 'Dinlemeye hazƒ±r';
                avatar.classList.remove('speaking');
            }
        }

        function updateStatus(text, mode) {
            const statusText = document.getElementById('statusText');
            const statusDot = document.getElementById('statusDot');
            
            if (!statusText || !statusDot) {
                console.error('Durum g√∂sterge √∂ƒüeleri bulunamadƒ±');
                return;
            }
            
            statusText.textContent = text;
            
            // √ñnceki t√ºm durumlarƒ± temizle
            statusDot.classList.remove('status-listening', 'status-speaking', 'status-idle', 'status-processing', 'status-completed', 'status-error');
            
            // Yeni durumu ekle
            statusDot.classList.add(`status-${mode}`);
        }

        async function speakResponse(text) {
            try {
                // Ses dosyasƒ± i√ßin benzersiz isim olu≈ütur
                const timestamp = new Date().getTime();
                const random = Math.floor(Math.random() * 1000000);
                
                // OpenAI TTS isteƒüi g√∂nder
                const response = await fetch('/get_speech?text=' + encodeURIComponent(text), {
                    method: 'GET'
                });

                if (!response.ok) {
                    throw new Error('TTS isteƒüi ba≈üarƒ±sƒ±z oldu');
                }

                // Ses verisini al ve oynat
                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);

                return new Promise((resolve) => {
                    audio.onplay = () => {
                        console.log('GPT konu≈ümaya ba≈üladƒ±');
                        isSpeaking = true;
                        isGPTSpeaking = true;
                        updateStatus('GPT yanƒ±t veriyor...', 'speaking');
                        updateAvatarState('speaking');
                    };

                    audio.onended = async () => {
                        console.log('GPT konu≈ümasƒ± bitti');
                        URL.revokeObjectURL(audioUrl);
                        isSpeaking = false;
                        isGPTSpeaking = false;

                        // Mikrofon sistemini sƒ±fƒ±rla ve kontrole ba≈üla
                        try {
                            if (!isAudioInitialized) {
                                console.log('Mikrofon sistemi yeniden ba≈ülatƒ±lƒ±yor...');
                                await initAudio();
                            }

                        if (isAutoMode) {
                                console.log('GPT konu≈ümasƒ± bitti - Otomatik ses algƒ±lama yeniden ba≈ülatƒ±lƒ±yor');
                            updateStatus('Sesinizi bekliyorum...', 'auto');
                            updateAvatarState('listening');
                                
                                // Yeniden ses kaydƒ±na ba≈üla
                                silenceStart = null; // Sessizlik sayacƒ±nƒ± sƒ±fƒ±rla
                                if (silenceTimeout) {
                                    clearTimeout(silenceTimeout);
                                    silenceTimeout = null;
                                }
                                
                                if (!isRecording && mediaRecorder && mediaRecorder.state === 'inactive') {
                                    console.log('Asistan konu≈ümasƒ± bitti - Otomatik kayƒ±t yeniden ba≈ülatƒ±lƒ±yor');
                                    startRecording();
                                }
                        } else {
                                console.log('GPT konu≈ümasƒ± bitti - Manuel mod hazƒ±r');
                            updateStatus('Space tu≈üuna basƒ±lƒ± tutarak konu≈üun', 'manual');
                            updateAvatarState('idle');
                            }
                        } catch (error) {
                            console.error('GPT konu≈ümasƒ± sonrasƒ± yeniden ba≈ülatma hatasƒ±:', error);
                        }

                        resolve();
                    };

                    audio.onerror = (error) => {
                        console.error('Ses oynatma hatasƒ±:', error);
                        URL.revokeObjectURL(audioUrl);
                        isSpeaking = false;
                        isGPTSpeaking = false;
                        updateStatus('Ses oynatma hatasƒ±', 'error');
                        updateAvatarState('idle');
                        resolve();
                    };

                    audio.play().catch((error) => {
                        console.error('Ses oynatma ba≈ülatma hatasƒ±:', error);
                        URL.revokeObjectURL(audioUrl);
                        resolve();
                    });
                });
            } catch (error) {
                console.error('TTS hatasƒ±:', error);
                isSpeaking = false;
                isGPTSpeaking = false;
                updateStatus('Ses olu≈üturma hatasƒ±', 'error');
                updateAvatarState('idle');
            }
        }

        async function initializeInterview() {
            try {
                console.log("initializeInterview ba≈ülatƒ±ldƒ±");
                // M√ºlakat kodunu al
                const interviewCode = new URLSearchParams(window.location.search).get('code');
                if (!interviewCode) {
                    showError('M√ºlakat kodu bulunamadƒ±');
                    return false;
                }
                
                // Avatar bile≈üenini g√∂ster
                const avatar = document.getElementById('duftechAvatar');
                if (avatar) {
                    avatar.style.display = 'flex';
                } else {
                    console.warn("duftechAvatar bulunamadƒ±");
                }
                
                // Mod butonlarƒ±nƒ± g√∂ster
                const modeButton = document.getElementById('modeButton');
                const manualModeButton = document.getElementById('manualModeButton');
                const autoModeButton = document.getElementById('autoModeButton');
                const endInterviewButton = document.getElementById('endInterviewButton');
                
                if (modeButton) {
                    modeButton.style.display = 'flex';
                    modeButton.classList.remove('hidden');
                } else {
                    console.warn("modeButton bulunamadƒ±");
                }
                
                if (manualModeButton) {
                    manualModeButton.style.display = 'none';
                } else {
                    console.warn("manualModeButton bulunamadƒ±");
                }
                
                if (autoModeButton) {
                    autoModeButton.style.display = 'none';
                } else {
                    console.warn("autoModeButton bulunamadƒ±");
                }
                
                if (endInterviewButton) {
                    endInterviewButton.style.display = 'flex';
                } else {
                    console.warn("endInterviewButton bulunamadƒ±");
                }
                
                // Giri≈ü formunu gizle (eƒüer varsa)
                const startContainer = document.getElementById('startContainer');
                if (startContainer) {
                    startContainer.style.display = 'none';
                } else {
                    console.warn("startContainer bulunamadƒ±");
                }
                
                // Chat containerƒ± g√∂ster (eƒüer varsa)
                const chatContainer = document.getElementById('chatContainer');
                if (chatContainer) {
                    chatContainer.style.display = 'block';
                } else {
                    console.warn("chatContainer bulunamadƒ±");
                }
                
                // Realtime session ba≈ülat
                await initializeRealtimeSession();
                
                // M√ºlakatƒ± ba≈ülat
                window.interviewStarted = true;
                isAutoMode = false; // Manuel modda ba≈ülat
                
                console.log("initializeInterview ba≈üarƒ±yla tamamlandƒ±");
                return true;
            } catch (error) {
                console.error('M√ºlakat ba≈ülatma hatasƒ±:', error);
                showError('M√ºlakat ba≈ülatma hatasƒ±: ' + error.message);
                return false;
            }
        }

        async function sendAudioToServer(audioBlob) {
            try {
                if (isGPTSpeaking) {
                    console.log('GPT konu≈üuyor, ses kaydƒ± i≈ülenmeyecek');
                    return;
                }

                if (audioBlob.size === 0) {
                    console.log('Bo≈ü ses kaydƒ±, i≈ülem yapƒ±lmayacak');
                    return;
                }

                // ƒ∞≈ülem a≈üamalarƒ±nƒ± g√∂ster
                showProcessingSteps();
                updateProcessingStep('transcribe', 'active');
                updateAvatarState('processing');

                const formData = new FormData();
                formData.append('audio', audioBlob, 'audio.webm');
                formData.append('code', interviewCode);

                const response = await fetch('/process_audio', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    hideProcessingSteps();
                    const errorText = await response.text();
                    console.error('Sunucu yanƒ±t detayƒ±:', errorText);
                    throw new Error(`HTTP error! status: ${response.status}, detail: ${errorText}`);
                }
                
                const data = await response.json();
                console.log('Sunucu yanƒ±tƒ±:', data);
                
                if (data.success) {
                    // Ses tanƒ±ma tamamlandƒ±
                    updateProcessingStep('transcribe', 'completed');
                    updateProcessingStep('evaluate', 'active');

                    if (data.transcript) {
                        // √ñnceki kullanƒ±cƒ± mesajlarƒ±nƒ± temizle
                        const existingUserMessages = document.querySelectorAll('.chat-bubble.user-bubble');
                        existingUserMessages.forEach(msg => {
                            msg.classList.add('fade-out');
                            setTimeout(() => msg.remove(), 300);
                        });
                        
                        // Yeni kullanƒ±cƒ± mesajƒ±nƒ± ekle
                        addMessageToChat('user', data.transcript);
                    }

                    // Deƒüerlendirme tamamlandƒ±
                    updateProcessingStep('evaluate', 'completed');
                    updateProcessingStep('respond', 'active');
                    updateAvatarState('speaking');

                    if (data.response) {
                        // GPT konu≈ümaya ba≈ülamadan √∂nce ses algƒ±lamayƒ± durdur
                        isGPTSpeaking = true;
                        stopVoiceDetection();
                        
                        // Yanƒ±t hazƒ±r
                        updateProcessingStep('respond', 'completed');
                        setTimeout(() => {
                            hideProcessingSteps();
                        }, 1000);

                        // √ñnceki asistan mesajlarƒ±nƒ± temizle
                        const existingAssistantMessages = document.querySelectorAll('.chat-bubble.assistant-bubble');
                        existingAssistantMessages.forEach(msg => {
                            msg.classList.add('fade-out');
                            setTimeout(() => msg.remove(), 300);
                        });

                        // √ñnce sesi oynat, sonra mesajƒ± g√∂ster
                        await speakResponse(data.response);
                        addMessageToChat('assistant', data.response);
                    }
                    
                    if (data.interview_ended) {
                        interviewEnded = true;
                        await endInterview();
                    }
                } else {
                    hideProcessingSteps();
                    showError(data.error || 'Ses i≈ülenemedi');
                    
                    if (data.continue_listening && !interviewEnded) {
                        setTimeout(async () => {
                            if (isAutoMode) {
                                updateAvatarState('listening');
                                updateStatus('Sesinizi bekliyorum...', 'auto');
                                startVoiceDetection();
                            }
                        }, 1000);
                    }
                }
            } catch (error) {
                hideProcessingSteps();
                console.error('Sunucu hatasƒ±:', error);
                showError('Sunucu ile ileti≈üim hatasƒ±: ' + error.message);
                
                if (!interviewEnded) {
                    setTimeout(async () => {
                        if (isAutoMode) {
                            updateAvatarState('listening');
                            updateStatus('Sesinizi bekliyorum...', 'auto');
                            startVoiceDetection();
                        }
                    }, 1000);
                }
            }
        }

        function stopVoiceDetection() {
            console.log('Ses algƒ±lama manuel olarak durduruluyor...');
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
            isRecording = false;
            silenceStart = null;
            
            // Ses akƒ±≈üƒ±nƒ± tamamen durdur
            if (audioStream) {
                audioStream.getTracks().forEach(track => track.stop());
            }
            
            // AudioContext'i askƒ±ya al
            if (audioContext) {
                audioContext.suspend();
            }
            
            isAutoMode = false;
            updateStatus('Manuel moda ge√ßildi', 'manual');
            updateAvatarState('idle');
        }

        function showProcessingSteps() {
            if (!document.querySelector('.processing-steps')) {
                const stepsDiv = document.createElement('div');
                stepsDiv.className = 'processing-steps';
                stepsDiv.innerHTML = `
                    <div class="processing-step" data-step="transcribe">
                        <i class="fas fa-microphone"></i>
                        <span>Ses tanƒ±nƒ±yor...</span>
                    </div>
                    <div class="processing-step" data-step="evaluate">
                        <i class="fas fa-brain"></i>
                        <span>Deƒüerlendiriliyor...</span>
                    </div>
                    <div class="processing-step" data-step="respond">
                        <i class="fas fa-comment"></i>
                        <span>Yanƒ±t hazƒ±rlanƒ±yor...</span>
                    </div>
                `;
                document.body.appendChild(stepsDiv);
            }

            const stepsElement = document.querySelector('.processing-steps');
            stepsElement.style.display = 'block';
            
            // Status indicator'ƒ± yukarƒ± kaydƒ±r
            const statusIndicator = document.querySelector('.status-indicator');
            if (statusIndicator) {
                statusIndicator.style.bottom = '160px';
            }
        }

        function hideProcessingSteps() {
            const stepsElement = document.querySelector('.processing-steps');
            if (stepsElement) {
                stepsElement.style.display = 'none';
                // T√ºm adƒ±mlarƒ± sƒ±fƒ±rla
                document.querySelectorAll('.processing-step').forEach(step => {
                    step.className = 'processing-step';
                });
                
                // Status indicator'ƒ± eski konumuna getir
                const statusIndicator = document.querySelector('.status-indicator');
                if (statusIndicator) {
                    statusIndicator.style.bottom = '80px';
                }
            }
        }

        function updateProcessingStep(stepName, status) {
            const step = document.querySelector(`.processing-step[data-step="${stepName}"]`);
            if (step) {
                // √ñnce mevcut sƒ±nƒ±flarƒ± temizle
                step.className = 'processing-step';
                
                // Yeni durumu ekle
                step.classList.add(status);
                
                // ƒ∞konu g√ºncelle
                const icon = step.querySelector('i');
                if (icon) {
                    if (status === 'active') {
                        icon.className = 'fas fa-spinner step-spinner';
                    } else if (status === 'completed') {
                        icon.className = 'fas fa-check text-green-500';
                    } else {
                        // Varsayƒ±lan ikonlarƒ± geri y√ºkle
                        switch(stepName) {
                            case 'transcribe':
                                icon.className = 'fas fa-microphone';
                                break;
                            case 'evaluate':
                                icon.className = 'fas fa-brain';
                                break;
                            case 'respond':
                                icon.className = 'fas fa-comment';
                                break;
                        }
                    }
                }
            }
        }

        // WebM'den WAV'a d√∂n√º≈üt√ºrme fonksiyonu
        async function convertToWav(webmBlob) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const arrayBuffer = await webmBlob.arrayBuffer();
            const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
            
            const numberOfChannels = 1;
            const length = audioBuffer.length;
            const sampleRate = 16000;
            const buffer = audioContext.createBuffer(numberOfChannels, length, sampleRate);
            
            // Ses verilerini kopyala
            const channelData = audioBuffer.getChannelData(0);
            buffer.copyToChannel(channelData, 0);
            
            // WAV formatƒ±na d√∂n√º≈üt√ºr
            const wavData = audioBufferToWav(buffer);
            return new Blob([wavData], { type: 'audio/wav' });
        }

        // AudioBuffer'ƒ± WAV formatƒ±na d√∂n√º≈üt√ºrme
        function audioBufferToWav(buffer) {
            const numberOfChannels = 1;
            const sampleRate = 16000;
            const format = 1; // PCM
            const bitDepth = 16;
            
            const bytesPerSample = bitDepth / 8;
            const blockAlign = numberOfChannels * bytesPerSample;
            
            const buffer32 = new Int32Array(44 + buffer.length * bytesPerSample);
            const view = new DataView(buffer32.buffer);
            
            // WAV header
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + buffer.length * bytesPerSample, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, format, true);
            view.setUint16(22, numberOfChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * blockAlign, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitDepth, true);
            writeString(view, 36, 'data');
            view.setUint32(40, buffer.length * bytesPerSample, true);
            
            // Ses verilerini yaz
            const data = buffer.getChannelData(0);
            let offset = 44;
            for (let i = 0; i < data.length; i++, offset += 2) {
                const sample = Math.max(-1, Math.min(1, data[i]));
                view.setInt16(offset, sample < 0 ? sample * 0x8000 : sample * 0x7FFF, true);
            }
            
            return buffer32.buffer;
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        function addMessageToChat(role, message) {
            // Mesajƒ± ge√ßmi≈üe ekle
            chatHistory.push({
                role: role,
                content: message
            });

            // √ñnceki mesajlarƒ± temizle
            const existingMessages = document.querySelectorAll(`.chat-bubble.${role}-bubble`);
            existingMessages.forEach(msg => {
                msg.classList.add('fade-out');
                setTimeout(() => msg.remove(), 300);
            });

            // Yeni mesaj olu≈ütur
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-bubble ${role}-bubble`;
            
            // Mesaj i√ßeriƒüi
            const content = document.createElement('div');
            content.className = 'message-content';
            
            // ƒ∞kon container
            const iconContainer = document.createElement('div');
            iconContainer.className = 'message-icon';
            iconContainer.innerHTML = `<i class="fas fa-${role === 'assistant' ? 'robot' : 'user'} text-lg"></i>`;
            
            // Mesaj metni
            const textContainer = document.createElement('div');
            textContainer.className = 'message-text';
            textContainer.textContent = message;
            
            // Elementleri birle≈ütir
            content.appendChild(iconContainer);
            content.appendChild(textContainer);
            messageDiv.appendChild(content);
            
            // Mesajƒ± ekle
            const chatContainer = document.getElementById('messages');
            chatContainer.appendChild(messageDiv);
            
            // Animasyon i√ßin timeout
            requestAnimationFrame(() => {
                messageDiv.classList.add('active');
            });

            // Robot animasyonunu g√ºncelle
            if (role === 'assistant') {
                updateAvatarState('speaking');
            }
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in';
            errorDiv.style.animation = 'fadeIn 0.3s ease-in-out';
            errorDiv.textContent = message;
            
            // Hata mesajƒ± i√ßin animasyonlar
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background-color: #ef4444;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 9999;
                animation: fadeIn 0.3s ease-in-out;
            `;
            
            // Keyframes ekle
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeIn {
                    from { opacity: 0; transform: translateY(-20px); }
                    to { opacity: 1; transform: translateY(0); }
                }
                @keyframes fadeOut {
                    from { opacity: 1; transform: translateY(0); }
                    to { opacity: 0; transform: translateY(-20px); }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(errorDiv);
            
            // 3 saniye sonra kaldƒ±r
            setTimeout(() => {
                errorDiv.style.animation = 'fadeOut 0.3s ease-in-out';
                setTimeout(() => {
                    errorDiv.remove();
                }, 300);
            }, 3000);
        }

        async function endInterview() {
            if (interviewEnded) return;
            
            try {
                updateStatus('M√ºlakat sonlandƒ±rƒ±lƒ±yor...', 'processing');
                
                // T√ºm kaynaklarƒ± temizle
                if (isRecording) {
                    await stopRecording();
                }
                
                // Kamerayƒ± kapat
                stopCamera();
                
                // M√ºlakatƒ± sonlandƒ±r
                interviewEnded = true;
                
                // Mod butonlarƒ±nƒ± gizle
                document.getElementById('modeButtonsContainer').style.display = 'none';
                
                // Mod durumu barƒ±nƒ± gizle
                document.getElementById('modStatusBar').style.display = 'none';
                
                // M√ºlakat durumunu kaydet
                await fetch('/save_interview_state', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        code: interviewCode,
                        conversation_history: chatHistory,
                        ended: true
                    })
                });
                
                // Son mesajƒ± kontrol et
                let lastMessage = '';
                if (chatHistory.length > 0) {
                    lastMessage = chatHistory[chatHistory.length - 1].content || '';
                }
                
                // Tamamlanma mesajƒ±nƒ± g√∂ster
                addMessageToChat('assistant', 'M√ºlakat tamamlandƒ±. Te≈üekk√ºr ederiz. Raporunuz olu≈üturuluyor...');
                await speakResponse('M√ºlakat tamamlandƒ±. Te≈üekk√ºr ederiz. Raporunuz olu≈üturuluyor...');
                
                // Rapor olu≈ütur
                const reportResult = await generateReport();
                
                updateStatus('M√ºlakat tamamlandƒ±', 'completed');
                document.getElementById('duftechAvatar').classList.add('completed');
                
                // Sonu√ß mesajƒ±nƒ± g√∂ster
                const resultContainer = document.createElement('div');
                resultContainer.className = 'flex items-center justify-center my-8';
                resultContainer.innerHTML = `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-6 text-center max-w-lg">
                        <div class="text-green-600 text-5xl mb-4">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <h2 class="text-xl font-bold text-green-800 mb-2">M√ºlakat Tamamlandƒ±!</h2>
                        <p class="text-green-700 mb-4">Rapor ba≈üarƒ±yla olu≈üturuldu.</p>
                        <a href="/reports/${interviewCode}_report.pdf" target="_blank" 
                           class="report-button">
                            <i class="fas fa-file-pdf mr-2"></i>Raporu ƒ∞ndir
                        </a>
                    </div>
                `;
                document.getElementById('messages').appendChild(resultContainer);
                
            } catch (error) {
                console.error('M√ºlakat bitirme hatasƒ±:', error);
                showError('M√ºlakat sonlandƒ±rƒ±lƒ±rken bir hata olu≈ütu: ' + error.message);
            }
        }

        async function generateReport() {
            try {
                console.log('Rapor olu≈üturma ba≈ülatƒ±lƒ±yor...', chatHistory);
                
                // Rapor olu≈üturma isteƒüi g√∂nder
                const response = await fetch('/generate_report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        interview_code: interviewCode,
                        conversation_history: chatHistory
                    })
                });

                const data = await response.json();
                console.log('Rapor yanƒ±tƒ±:', data);

                if (data.success) {
                    showSuccess('Rapor ba≈üarƒ±yla olu≈üturuldu!');
                    
                    // Rapor URL'i olu≈ütur
                    const reportUrl = `/reports/${interviewCode}_report.pdf`;
                    
                    // Mevcut indirme butonunun doƒüru √ßalƒ±≈ümasƒ± i√ßin
                    setTimeout(() => {
                        const downloadLinks = document.querySelectorAll('a[href*="_report.pdf"]');
                        downloadLinks.forEach(link => {
                            link.href = reportUrl;
                            link.addEventListener('click', function(e) {
                                e.preventDefault();
                                window.open(reportUrl, '_blank');
                            });
                        });
                    }, 500);
                    
                    return true;
                } else {
                    throw new Error(data.error || 'Rapor olu≈üturma hatasƒ±');
                }
            } catch (error) {
                console.error('Rapor olu≈üturma hatasƒ±:', error);
                showError('Rapor olu≈üturulurken bir hata olu≈ütu: ' + error.message);
                return false;
            }
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            successDiv.textContent = message;
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.remove();
            }, 5000);
        }

        // Avatar durumunu g√ºncelleyen fonksiyon
        function updateAvatarState(state) {
            const avatar = document.getElementById('duftechAvatar');
            if (!avatar) {
                console.error('Avatar √∂ƒüesi bulunamadƒ±');
                return;
            }
            
            // √ñnceki t√ºm durumlarƒ± temizle
            avatar.classList.remove('speaking', 'listening', 'idle', 'processing', 'completed');
            
            // Yeni durumu ekle
            avatar.classList.add(state);
        }

        // Ger√ßek zamanlƒ± sohbet i√ßin SSE kullanƒ±mƒ±
        async function startRealtimeChat(message) {
            try {
                const response = await fetch('/realtime_chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('interview_token')}`
                    },
                    body: JSON.stringify({
                        message: message,
                        session_id: localStorage.getItem('interview_session_id')
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const {value, done} = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                if (data.text) {
                                    addMessageToChat('assistant', data.text);
                                    await speakResponse(data.text);
                                }
                            } catch (e) {
                                console.error('JSON parse hatasƒ±:', e);
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Ger√ßek zamanlƒ± sohbet hatasƒ±:', error);
                showError('Baƒülantƒ± hatasƒ±: ' + error.message);
            }
        }

        // S√ºre sayacƒ± fonksiyonlarƒ±
        function startTimer() {
            interviewStartTime = new Date();
            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
        }

        function updateTimer() {
            if (!interviewStartTime) return;
            
            const now = new Date();
            const diff = now - interviewStartTime;
            const minutes = Math.floor(diff / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);
            
            document.getElementById('interviewTimer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Kamera i≈ülemleri
        async function initCamera() {
            try {
                if (!cameraActive) {
                    // Kamera eri≈üimi i√ßin izin iste
                    videoStream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            width: { ideal: 1280 },
                            height: { ideal: 720 },
                            facingMode: "user" 
                        } 
                    });
                    
                    const videoElement = document.getElementById('videoElement');
                    videoElement.srcObject = videoStream;
                    
                    // Kamera konteynerini g√∂ster
                    document.getElementById('cameraContainer').style.display = 'block';
                    cameraActive = true;
                    
                    // Rastgele fotoƒüraf √ßekme zamanlamasƒ±nƒ± ba≈ülat
                    startRandomPhotoCapture();
                }
            } catch (error) {
                console.error('Kamera eri≈üim hatasƒ±:', error);
                showError('Kamera eri≈üimi saƒülanamadƒ±: ' + error.message);
            }
        }
        
        function startRandomPhotoCapture() {
            // Rastgele zamanlarda fotoƒüraf √ßekme
            photoInterval = setInterval(() => {
                // 10-30 saniye arasƒ±nda rastgele bir s√ºre sonra fotoƒüraf √ßek
                const randomDelay = Math.floor(Math.random() * 20000) + 10000; // 10-30 saniye arasƒ±
                
                // Son fotoƒüraftan bu yana yeterli s√ºre ge√ßtiyse
                const now = Date.now();
                if (now - lastPhotoTime > randomDelay) {
                    capturePhoto();
                    lastPhotoTime = now;
                }
            }, 5000); // 5 saniyede bir kontrol et
        }
        
        function capturePhoto() {
            if (!cameraActive) return;
            
            const video = document.getElementById('videoElement');
            const canvas = document.getElementById('photoCanvas');
            const photoFlash = document.getElementById('photoFlash');
            
            // Canvas boyutunu video boyutuna ayarla
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Fotoƒüraf √ßek
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Fla≈ü efekti
            photoFlash.classList.add('active');
            setTimeout(() => {
                photoFlash.classList.remove('active');
            }, 300);
            
            // Fotoƒürafƒ± base64 formatƒ±na √ßevir
            const photoData = canvas.toDataURL('image/jpeg');
            
            // Fotoƒürafƒ± sunucuya g√∂nder
            sendPhotoToServer(photoData);
            
            photoCounter++;
        }
        
        async function sendPhotoToServer(photoData) {
            try {
                const response = await fetch('/save_photo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        code: interviewCode,
                        photo: photoData,
                        timestamp: new Date().toISOString()
                    })
                });
                
                const data = await response.json();
                if (!data.success) {
                    console.error('Fotoƒüraf kaydedilemedi:', data.error);
                }
            } catch (error) {
                console.error('Fotoƒüraf g√∂nderme hatasƒ±:', error);
            }
        }
        
        // Kamerayƒ± kapat
        function stopCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            
            if (photoInterval) {
                clearInterval(photoInterval);
                photoInterval = null;
            }
            
            document.getElementById('cameraContainer').style.display = 'none';
            cameraActive = false;
        }

        function addDownloadButton(reportUrl) {
            const container = document.querySelector('.chat-container');
            const downloadDiv = document.createElement('div');
            downloadDiv.className = 'fixed bottom-4 right-4 flex gap-4';
            
            const downloadButton = document.createElement('button');
            downloadButton.className = 'bg-indigo-600 text-white px-6 py-3 rounded-lg shadow-lg hover:bg-indigo-700 transition-colors';
            downloadButton.innerHTML = '<i class="fas fa-download mr-2"></i>Raporu ƒ∞ndir';
            downloadButton.onclick = () => {
                const link = document.createElement('a');
                link.href = reportUrl;
                link.download = `mulakat_raporu_${new Date().toISOString().slice(0,10)}.pdf`;
                link.click();
            };
            
            downloadDiv.appendChild(downloadButton);
            container.appendChild(downloadDiv);
        }

        // TTS desteƒüini kontrol eden fonksiyon
        function checkTtsSupport() {
            if ('speechSynthesis' in window) {
                console.log('Web Speech API destekleniyor');
                // Sesler hazƒ±r olduƒüunda √ßaƒürƒ±lacak
                window.speechSynthesis.onvoiceschanged = function() {
                    const voices = window.speechSynthesis.getVoices();
                    console.log(`${voices.length} ses bulundu`);
                };
            } else {
                console.warn('Web Speech API desteklenmiyor');
            }
        }

        // Ses kaydƒ± i≈üleme sistemini kuran fonksiyon
        async function setupAudioProcessing(stream) {
            try {
                console.log("setupAudioProcessing ba≈ülatƒ±ldƒ±");
                // √ñnceki ses akƒ±≈üƒ±nƒ± temizle
                if (audioStream) {
                    audioStream.getTracks().forEach(track => track.stop());
                }
                
                // Yeni ses akƒ±≈üƒ±nƒ± kaydet
                audioStream = stream;
                
                // AudioContext olu≈ütur
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                const source = audioContext.createMediaStreamSource(audioStream);
                source.connect(analyser);
                analyser.fftSize = 2048;
                
                // MediaRecorder'ƒ± ayarla
                mediaRecorder = new MediaRecorder(audioStream, {
                    mimeType: 'audio/webm;codecs=opus',
                    audioBitsPerSecond: 16000
                });
                
                mediaRecorder.ondataavailable = (event) => {
                    if (!isGPTSpeaking && event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = async () => {
                    if (!isGPTSpeaking && audioChunks.length > 0) {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        if (audioBlob.size > 0) {
                            try {
                                await processAudio(audioBlob);
                            } catch (error) {
                                console.error('Ses i≈üleme hatasƒ±:', error);
                            }
                        }
                        audioChunks = [];
                    }
                };
                
                // Ses seviyesi kontrol√ºn√º ba≈ülat
                if (typeof checkAudioLevel === 'function') {
                    console.log("checkAudioLevel fonksiyonu √ßaƒürƒ±lƒ±yor");
                    requestAnimationFrame(checkAudioLevel);
                } else {
                    console.error("checkAudioLevel fonksiyonu tanƒ±mlƒ± deƒüil!");
                }
                
                isMediaRecorderReady = true;
                isAudioInitialized = true;
                console.log("setupAudioProcessing ba≈üarƒ±yla tamamlandƒ±");
                
                return true;
            } catch (error) {
                console.error('Ses sistemi ba≈ülatma hatasƒ±:', error);
                showError('Mikrofon eri≈üimi saƒülanamadƒ±');
                return false;
            }
        }

        // Sohbet balonu olu≈üturan fonksiyon
        function createChatBubble(role, message) {
            const messagesContainer = document.getElementById('messages');
            if (!messagesContainer) {
                console.error('Mesaj konteyneri bulunamadƒ±');
                return;
            }
            
            // √ñnceki mesajlarƒ± temizle (eƒüer √ßok fazla varsa)
            const allBubbles = document.querySelectorAll('.chat-bubble');
            if (allBubbles.length > 10) {
                allBubbles[0].remove(); // En eski mesajƒ± kaldƒ±r
            }
            
            // Sƒ±nƒ±f ve pozisyon
            const bubbleType = role === 'assistant' ? 'assistant-bubble' : 'user-bubble';
            const positions = ['position-1', 'position-2', 'position-3', 'position-4', 'position-5', 'position-6'];
            const position = positions[Math.floor(Math.random() * positions.length)];
            
            // Yeni balon olu≈ütur
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${bubbleType} ${position}`;
            
            // ƒ∞√ßerik
            const content = document.createElement('div');
            content.className = 'message-content';
            
            // ƒ∞kon
            const icon = document.createElement('div');
            icon.className = 'message-icon';
            
            if (role === 'assistant') {
                icon.innerHTML = '<i class="fas fa-robot"></i>';
            } else {
                icon.innerHTML = '<i class="fas fa-user"></i>';
            }
            
            // Metin
            const text = document.createElement('div');
            text.className = 'message-text';
            text.textContent = message;
            
            // Bile≈üenleri bir araya getir
            content.appendChild(icon);
            content.appendChild(text);
            bubble.appendChild(content);
            messagesContainer.appendChild(bubble);
            
            // Animasyon i√ßin setTimeout
            setTimeout(() => {
                bubble.classList.add('active');
            }, 10);
            
            return bubble;
        }

        // Buton dinleyicilerini ayarlayan fonksiyon
        function setupButtonListeners() {
            console.log('Buton dinleyicileri ayarlanƒ±yor...');
            
            // Ana ba≈ülatma butonu
            const modeButton = document.getElementById('modeButton');
            if (modeButton) {
                modeButton.addEventListener('click', startInterview);
            } else {
                console.error('modeButton bulunamadƒ±');
            }
            
            // Manuel mod butonu
            const manualModeButton = document.getElementById('manualModeButton');
            if (manualModeButton) {
                manualModeButton.addEventListener('click', function() {
                    enableManualMode();
                });
            } else {
                console.error('manualModeButton bulunamadƒ±');
            }

            // Otomatik mod butonu
            const autoModeButton = document.getElementById('autoModeButton');
            if (autoModeButton) {
                autoModeButton.addEventListener('click', function() {
                    enableAutoMode();
                });
            } else {
                console.error('autoModeButton bulunamadƒ±');
            }
            
            // M√ºlakat bitirme butonu
            const endInterviewButton = document.getElementById('endInterviewButton');
            if (endInterviewButton) {
                endInterviewButton.addEventListener('click', endInterview);
            } else {
                console.error('endInterviewButton bulunamadƒ±');
            }
            
            // Klavye dinleyicileri - Manuel mod i√ßin Space tu≈üu desteƒüi
            // NOT: Bu event listener'lar DOMContentLoaded i√ßinde tanƒ±mlandƒ±, burada tekrar tanƒ±mlamƒ±yoruz
            /*
            document.addEventListener('keydown', function(event) {
                if (event.code === 'Space' && !isAutoMode && !isGPTSpeaking && !isRecording && !interviewEnded) {
                    event.preventDefault(); // Sayfanƒ±n a≈üaƒüƒ± kaymasƒ±nƒ± engelle
                    startRecording();
                    updateStatus('Kayƒ±t yapƒ±lƒ±yor...', 'recording');
                    manualModeButton.classList.add('active');
                    manualModeButton.innerHTML = '<i class="fas fa-microphone record-indicator"></i><span>Kaydediliyor...</span>';
                }
            });

            document.addEventListener('keyup', function(event) {
                if (event.code === 'Space' && !isAutoMode && isRecording && !interviewEnded) {
                    stopRecording();
                    updateStatus('ƒ∞≈üleniyor...', 'processing');
                    manualModeButton.classList.remove('active');
                    manualModeButton.innerHTML = '<i class="fas fa-hand"></i><span>Manuel Mod</span>';
                }
            });
            */
            
            console.log('Buton dinleyicileri ayarlandƒ±');
        }
        
        // T√ºm kayƒ±t durum deƒüi≈ükenlerini sƒ±fƒ±rla
        function resetRecordingState() {
            console.log("Kayƒ±t durumu sƒ±fƒ±rlandƒ±");
            isRecording = false;
            audioChunks = [];
            
            // Eƒüer bir MediaRecorder varsa ve aktifse, durdur
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                try {
                    mediaRecorder.stop();
                } catch (e) {
                    console.warn("MediaRecorder durdurma hatasƒ±:", e);
                }
            }
            
            // G√∂rsel geri bildirimleri kapat
            document.getElementById('statusDot').classList.remove('recording');
            document.getElementById('manualModeButton').classList.remove('recording-active');
            document.body.classList.remove('recording-active');
        }

        // Mevcut kod i√ßerisine eklenecek kƒ±sƒ±mlar
        async function startInterview() {
            try {
                console.log("startInterview fonksiyonu ba≈ülatƒ±ldƒ±");
                
                // M√ºlakata ba≈üla butonu yerine mod butonlarƒ±nƒ± g√∂ster
                const startButton = getElement('startButton', ['modeButton']);
                const modeButtonsContainer = getElement('modeButtonsContainer');
                
                if (startButton && modeButtonsContainer) {
                    startButton.style.display = 'none';
                    modeButtonsContainer.classList.remove('hidden');
                } else {
                    console.error("startButton veya modeButtonsContainer bulunamadƒ±");
                    showError('Aray√ºz √∂ƒüesi eksik');
                    return;
                }
                
                // Mod durum barƒ±nƒ± g√∂ster - En √ºstte
                const modStatusBar = document.getElementById('modStatusBar');
                if (modStatusBar) {
                    modStatusBar.style.display = 'block';
                    
                    // Header pozisyonunu ayarla
                    const header = document.querySelector('.header');
                    if (header) {
                        header.style.top = '36px'; // Mod bilgi √ßubuƒüunun altƒ±
                    }
                }
                
                // Kamera konteynerini saƒü √ºste ta≈üƒ± 
                const cameraContainer = document.getElementById('cameraContainer');
                if (cameraContainer) {
                    cameraContainer.style.top = '150px'; // Daha a≈üaƒüƒ±da
                    cameraContainer.style.right = '35px'; // Daha saƒüda
                    cameraContainer.style.width = '160px';
                    cameraContainer.style.height = '120px';
                }
                
                // Mod bilgisi g√∂stergesini ayarla
                const modeInfo = getElement('modeInfo');
                const autoModeInfo = getElement('autoModeInfo');
                
                if (modeInfo) modeInfo.classList.remove('hidden');
                if (autoModeInfo) autoModeInfo.classList.remove('hidden');
                
                // Varsayƒ±lan olarak otomatik modu etkinle≈ütir
                const toggleBtn = getElement('toggleModeButton');
                if (toggleBtn) {
                    toggleBtn.innerHTML = '<i class="fas fa-microphone-alt"></i><span>Otomatik Mod</span>';
                    toggleBtn.classList.remove('manual');
                }
                isAutoMode = true;
                
                // Kayƒ±t izni iste
                console.log("Mikrofon eri≈üimi isteniyor...");
                
                try {
                    // Mikrofon eri≈üimini ba≈ülat
                    const initialized = await initAudio();
                    if (!initialized) {
                        showError('Mikrofon eri≈üimi saƒülanamadƒ±');
                        return;
                    }
                    
                    // M√ºlakat ba≈ülatma API'sini √ßaƒüƒ±r
                    const response = await fetch('/start_interview', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            code: interviewCode
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // M√ºlakat ba≈üarƒ±yla ba≈ülatƒ±ldƒ±
                        console.log("M√ºlakat ba≈üarƒ±yla ba≈ülatƒ±ldƒ±:", data);
                        createChatBubble('assistant', data.welcome_message);
                        
                        // Otomatik modu ba≈ülat
                        updateStatus('Ses seviyeniz algƒ±landƒ±ƒüƒ±nda kayƒ±t ba≈ülar', 'auto');
                        updateAvatarState('listening');
                        
                        // Ses algƒ±lamayƒ± ba≈ülat
                        startVoiceDetection();
                        
                        // M√ºlakat zamanƒ±nƒ± ba≈ülat
                        if (typeof startInterviewTimer === 'function') {
                            startInterviewTimer();
                        } else {
                            // Fallback: Timer y√∂netimi
                            interviewStartTime = new Date();
                            updateTimer();
                            timerInterval = setInterval(updateTimer, 1000);
                        }
                    } else {
                        showError(data.error || 'M√ºlakat ba≈ülatƒ±lamadƒ±');
                    }
                } catch (error) {
                    console.error('Mikrofon hatasƒ±:', error);
                    showError('Mikrofon eri≈üim izni verilmedi');
                }
            } catch (error) {
                console.error('M√ºlakat ba≈ülatma hatasƒ±:', error);
                showError('M√ºlakat ba≈ülatƒ±lamadƒ±');
            }
        }
        
        // Ses seviyesini kontrol eden fonksiyon g√ºncelleniyor
        function checkAudioLevel() {
            if (!analyser) {
                requestAnimationFrame(checkAudioLevel);
                return;
            }
            
            try {
                const dataArray = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(dataArray);
                
                // Ses seviyesini hesapla (g√º√ßlendirilmi≈ü)
                let sum = 0;
                const len = dataArray.length;
                
                // T√ºm frekans bandƒ±nƒ± topla
                for (let i = 0; i < len; i++) {
                    sum += dataArray[i];
                }
                
                // 0-1 arasƒ±nda normalize et ve biraz vurgu yap
                const rawVolume = sum / (len * 255);
                const volume = Math.pow(rawVolume, 0.5); // D√º≈ü√ºk sesleri daha fazla y√ºkselt
                
                // Her 30 kare'de bir ses seviyesini logla
                if (Math.random() < 0.03) { // yakla≈üƒ±k her 30 framede bir
                    console.log(`G√ºncel ses seviyesi: ${volume.toFixed(4)} - E≈üikler: sessizlik=${SILENCE_THRESHOLD}, konu≈üma=${VOICE_THRESHOLD}`);
                }
                
                // Ses g√∂stergesini g√ºncelle
                updateVolumeIndicator(volume);
                
                // Otomatik mod ve sessize ge√ßi≈ü kontrol√º
                if (isAutoMode && !isGPTSpeaking && !interviewEnded) {
                    // Ses seviyesi e≈üiƒüini ge√ßtiyse ve kayƒ±t yapmƒ±yorsak ba≈ülat
                    if (volume > VOICE_THRESHOLD && !isRecording) {
                        console.log(`SES ALGILANDI (${volume.toFixed(4)} > ${VOICE_THRESHOLD}) - Kayƒ±t ba≈ülatƒ±lƒ±yor`);
                        startRecording();
                        document.body.classList.add('recording-active');
                    } 
                    // Kayƒ±t yapƒ±yorsak sessizlik kontrol√º
                    else if (isRecording) {
                        if (volume > VOICE_THRESHOLD) {
                            // Konu≈üma algƒ±landƒ±, sessizlik zamanlayƒ±cƒ±sƒ±nƒ± sƒ±fƒ±rla
                            if (silenceStart !== null) {
                                console.log('Sessizlik bitti, konu≈üma devam ediyor');
                            }
                            silenceStart = null;
                            if (silenceTimeout) {
                                clearTimeout(silenceTimeout);
                                silenceTimeout = null;
                            }
                        } else if (volume < SILENCE_THRESHOLD) {
                            // Sessizlik algƒ±landƒ±
                            if (!silenceStart) {
                                silenceStart = Date.now();
                                console.log('Sessizlik ba≈üladƒ±');
                            } else {
                                const silenceTime = Date.now() - silenceStart;
                                if (silenceTime > SILENCE_DURATION && !silenceTimeout) {
                                    console.log(`Sessizlik s√ºresi e≈üiƒüi a≈üƒ±ldƒ± (${silenceTime}ms > ${SILENCE_DURATION}ms)`);
                                    silenceTimeout = setTimeout(() => {
                                        silenceTimeout = null;
                                        if (isRecording) {
                                            console.log('Sessizlik e≈üiƒüi a≈üƒ±ldƒ±, kayƒ±t durduruluyor');
                                            stopRecording();
                                            updateStatus('ƒ∞≈üleniyor...', 'processing');
                                            document.body.classList.remove('recording-active');
                                        }
                                    }, 300); // Biraz bekleyip kaydƒ± durdur
                                }
                            }
                        }
                    }
                }
                
                requestAnimationFrame(checkAudioLevel);
            } catch (e) {
                console.error('Ses seviyesi kontrol√º hatasƒ±:', e);
                requestAnimationFrame(checkAudioLevel);
            }
        }

        // M√ºlakat zamanƒ±nƒ± ba≈ülatan fonksiyon
        function startInterviewTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            interviewStartTime = new Date();
            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);
        }

        // DOM elementlerini g√ºvenli bir ≈üekilde bulmak i√ßin yardƒ±mcƒ± fonksiyon
        function getElement(id, fallbackIds = []) {
            let element = document.getElementById(id);
            
            // Eƒüer element bulunamazsa fallback ID'leri dene
            if (!element && fallbackIds && fallbackIds.length > 0) {
                for (const fallbackId of fallbackIds) {
                    element = document.getElementById(fallbackId);
                    if (element) break;
                }
            }
            
            return element;
        }

        // Modal i≈ülemleri i√ßin fonksiyonlar
        function showModal() {
            document.getElementById('infoModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('infoModal').style.display = 'none';
        }

        // Gecikme ile kayƒ±t ba≈ülatan yeni fonksiyon
        function startRecordingWithTimeout(delay) {
            // √ñnce kayƒ±t durumunu g√ºncelle
            isRecording = true;
            audioChunks = [];
            
            // Belirtilen gecikme sonrasƒ±nda kaydƒ± ba≈ülat
            setTimeout(function() {
                if (!isRecording) {
                    console.log("Kayƒ±t iptal edilmi≈ü");
                    return;
                }
                
                try {
                    // Yeni bir MediaRecorder olu≈ütur
                    mediaRecorder = new MediaRecorder(audioStream, {
                        mimeType: 'audio/webm',
                        audioBitsPerSecond: 128000
                    });
                    
                    // dataavailable olayƒ±nƒ± i≈üle
                    mediaRecorder.ondataavailable = function(event) {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                            console.log(`Chunk eklendi, yeni boyut: ${event.data.size} bytes`);
                        }
                    };
                    
                    // Hata olayƒ±nƒ± i≈üle
                    mediaRecorder.onerror = function(err) {
                        console.error("MediaRecorder hatasƒ±:", err);
                        resetRecordingState();
                    };
                    
                    // Kayƒ±t durdurma olayƒ±nƒ± i≈üle
                    mediaRecorder.onstop = function() {
                        console.log(`MediaRecorder durduruldu, toplam chunk sayƒ±sƒ±: ${audioChunks.length}`);
                        
                        if (audioChunks.length === 0) {
                            console.warn("Ses verisi bulunamadƒ±!");
                            return;
                        }
                        
                        var audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        console.log(`Ses kaydƒ± tamamlandƒ±, boyut: ${audioBlob.size} bytes`);
                        processAudio(audioBlob);
                    };
                    
                    // Kaydƒ± ba≈ülat ve durum g√ºncelle
                    mediaRecorder.start(100); // 100ms aralƒ±klarla chunk toplama
                    console.log("Kayƒ±t ba≈ülatƒ±ldƒ±");
                    
                } catch (err) {
                    console.error("MediaRecorder ba≈ülatma hatasƒ±:", err);
                    resetRecordingState();
                }
            }, delay);
        }

        // Space tu≈üu ile manuel kayƒ±t mekanizmasƒ± - DOMContentLoaded i√ßinde tanƒ±mlandƒ±
        /* 
        document.addEventListener('keydown', async function(e) {
            if (e.code === 'Space' && !isAutoMode && !interviewEnded) {
                e.preventDefault(); // Sayfanƒ±n a≈üaƒüƒ± kaymasƒ±nƒ± engelle
                
                // GPT konu≈üuyorsa kayƒ±t yapmayƒ± engelle
                if (isGPTSpeaking) {
                    showError('L√ºtfen GPT konu≈ümasƒ±nƒ±n bitmesini bekleyin');
                    return;
                }
                
                if (!isRecording) {
                    console.log('Space tu≈üuna basƒ±ldƒ± - Manuel kayƒ±t ba≈ülatƒ±lƒ±yor');
                    
                    // G√∂rsel geri bildirim g√∂ster
                    document.getElementById('statusDot').style.backgroundColor = '#ef4444'; // Kƒ±rmƒ±zƒ±
                    document.getElementById('statusText').textContent = 'Kaydediliyor...';
                    document.body.classList.add('recording-active');
                    
                    // MediaRecorder hazƒ±r deƒüilse hazƒ±rla
                    if (!isMediaRecorderReady) {
                        await initAudio();
                    }
                    
                    // Kayƒ±t ba≈ülat
                    startRecording();
                    updateAvatarState('listening');
                }
            }
        });

        document.addEventListener('keyup', function(e) {
            if (e.code === 'Space' && !isAutoMode && !interviewEnded) {
                e.preventDefault();
                
                if (isRecording) {
                    console.log('Space tu≈üu bƒ±rakƒ±ldƒ± - Manuel kayƒ±t durduruluyor');
                    
                    // G√∂rsel geri bildirimi kapat
                    document.getElementById('statusDot').style.backgroundColor = '#6b7280'; // Gri
                    document.getElementById('statusText').textContent = 'Ses ƒ∞≈üleniyor...';
                    document.body.classList.remove('recording-active');
                    
                    stopRecording();
                    updateAvatarState('idle');
                }
            }
        });
        */

        // Manuel mod etkinle≈ütirme fonksiyonu
        function enableManualMode() {
            // Aktif kayƒ±t varsa √∂nce durdur
            if (isRecording) {
                stopRecording();
            }
            
            // Otomatik mod aktifse, √∂nce ses algƒ±lamayƒ± durdur
            if (isAutoMode && voiceDetectionInterval) {
                clearInterval(voiceDetectionInterval);
                voiceDetectionInterval = null;
            }
            
            isAutoMode = false;
            console.log("Mod deƒüi≈ütirildi: Manuel Mod (Space tu≈üu ile kaydet)");
            
            // G√∂rsel geri bildirimleri g√ºncelle
            document.getElementById('autoModeButton').classList.remove('active');
            document.getElementById('manualModeButton').classList.add('active');
            document.getElementById('autoModeInfo').style.display = 'none';
            document.getElementById('manualModeInfo').style.display = 'block';
            document.getElementById('statusText').textContent = "Manuel Mod Hazƒ±r (Space tu≈üuna basƒ±lƒ± tutarak konu≈üun)";
            document.getElementById('modeStatus').textContent = "MANUEL MOD";
            document.getElementById('modeIcon').innerHTML = "üéôÔ∏è";
            document.getElementById('modeIcon').classList.remove('auto-mode-active');
            
            // Avatar durumunu g√ºncelle
            updateAvatarState('idle');
        }

        // Otomatik mod etkinle≈ütirme fonksiyonu 
        function enableAutoMode() {
            // GPT konu≈üuyorsa mod deƒüi≈üimini engelle
            if (isGPTSpeaking) {
                showError('L√ºtfen GPT konu≈ümasƒ±nƒ±n bitmesini bekleyin');
                return;
            }
            
            // Kayƒ±t durumunu sƒ±fƒ±rla
            resetRecordingState();
            
            isAutoMode = true;
            console.log("Mod deƒüi≈ütirildi: Otomatik Mod (Ses algƒ±lama aktif)");
            
            // G√∂rsel geri bildirimleri g√ºncelle
            document.getElementById('manualModeButton').classList.remove('active');
            document.getElementById('autoModeButton').classList.add('active');
            document.getElementById('manualModeInfo').style.display = 'none';
            document.getElementById('autoModeInfo').style.display = 'block';
            document.getElementById('statusText').textContent = "Otomatik Mod Aktif";
            document.getElementById('modeStatus').textContent = "OTOMATƒ∞K MOD";
            document.getElementById('modeIcon').innerHTML = "üé§";
            document.getElementById('modeIcon').classList.add('auto-mode-active');
            
            // Ses algƒ±lamayƒ± ba≈ülat
            startVoiceDetection();
            
            // Avatar durumunu g√ºncelle
            updateAvatarState('listening');
        }

        // Mode butonlarƒ± i√ßin event listener'lar
        //        document.addEventListener('DOMContentLoaded', function() {
//            // Mod deƒüi≈ütirme butonu i√ßin event listener
//            const toggleModeButton = document.getElementById('toggleModeButton');
//            if (toggleModeButton) {
//                toggleModeButton.addEventListener('click', function() {
//                    if (!interviewEnded) {
//                        // Otomatik mod aktifse manuel moda ge√ß, deƒüilse otomatik moda ge√ß
//                        if (isAutoMode) {
//                            enableManualMode();
//                        } else {
//                            enableAutoMode();
//                        }
//                    }
//                });
//            } else {
//                console.error('toggleModeButton elementi bulunamadƒ±!');
//            }
//
//            /* Artƒ±k bu butonlar kullanƒ±lmadƒ±ƒüƒ± i√ßin bu kod par√ßasƒ± yorum satƒ±rƒ± haline getirildi
//            // Manuel mod butonu
//            document.getElementById('manualModeButton').addEventListener('click', function() {
//                if (!interviewEnded) {
//                    enableManualMode();
//                }
//            });
//
//            // Otomatik mod butonu
//            document.getElementById('autoModeButton').addEventListener('click', function() {
//                if (!interviewEnded) {
                    enableAutoMode();
                }
            });
            */
        });

        // CSS stillerini a≈üaƒüƒ±daki yolla ekliyoruz - tek seferde, DOMContentLoaded i√ßinde deƒüil
        (function() {
            // CSS stillerini ekle
            const style = document.createElement('style');
            style.textContent = `
                /* Kayƒ±t durumunu g√∂steren daire (ortadaki animasyon i√ßin) */
                .record-indicator {
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    width: 120px;
                    height: 120px;
                    border-radius: 50%;
                    background: rgba(239, 68, 68, 0.2);
                    box-shadow: 0 0 30px rgba(239, 68, 68, 0.3);
                    display: none;
                    justify-content: center;
                    align-items: center;
                    z-index: 1000;
                    pointer-events: none;
                }
                
                .recording-active .record-indicator {
                    display: flex;
                    animation: pulse 1.5s infinite;
                }
                
                @keyframes pulse {
                    0% { transform: translate(-50%, -50%) scale(1); opacity: 0.7; }
                    50% { transform: translate(-50%, -50%) scale(1.05); opacity: 1; }
                    100% { transform: translate(-50%, -50%) scale(1); opacity: 0.7; }
                }
                
                /* Mod butonlarƒ± i√ßin animasyonlar */
                #manualModeButton.recording-active {
                    background: linear-gradient(135deg, #ef4444 0%, #f97316 100%) !important;
                    transform: scale(1.05);
                    box-shadow: 0 0 15px rgba(239, 68, 68, 0.5) !important;
                }
                
                /* Manuel mod i√ßin g√ºlen y√ºz animasyonu */
                .smile-animation {
                    animation: bounce 1s infinite;
                    font-size: 40px;
                }
                
                @keyframes bounce {
                    0%, 100% { transform: translateY(0); }
                    50% { transform: translateY(-10px); }
                }
                
                /* Status dot animasyonu */
                #statusDot.recording {
                    animation: blink 1s infinite;
                    background-color: #ef4444 !important;
                }
                
                @keyframes blink {
                    0%, 100% { opacity: 1; }
                    50% { opacity: 0.5; }
                }
            `;
            document.head.appendChild(style);
        })();

        // Sayfa y√ºklendikten sonra toggle mode butonu i√ßin event listener ekler
        (function() {
            // DOMContentLoaded eventini beklemeden doƒürudan √ßalƒ±≈üƒ±r
            const toggleModeButton = document.getElementById('toggleModeButton');
            if (toggleModeButton) {
                toggleModeButton.addEventListener('click', function() {
                    if (typeof interviewEnded !== 'undefined' && !interviewEnded) {
                        // Otomatik mod aktifse manuel moda ge√ß, deƒüilse otomatik moda ge√ß
                        if (typeof isAutoMode !== 'undefined') {
                            if (isAutoMode) {
                                if (typeof enableManualMode === 'function') {
                                    enableManualMode();
                                }
                            } else {
                                if (typeof enableAutoMode === 'function') {
                                    enableAutoMode();
                                }
                            }
                        }
                    }
                });
                console.log('Toggle mode butonu i√ßin event listener ba≈üarƒ±yla eklendi');
            } else {
                console.error('toggleModeButton elementi bulunamadƒ±!');
            }
        })();
    </script>
</body>
</html> 