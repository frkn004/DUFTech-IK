<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mülakat Oluştur | DUF Tech Mülakat Sistemi</title>
    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css">
    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%);
            min-height: 100vh;
        }
        .glassmorphism {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .duftech-logo {
            width: 180px;
            transition: transform 0.3s ease;
        }
        .duftech-logo:hover {
            transform: scale(1.05);
        }
        .gradient-btn {
            background: linear-gradient(135deg, #00CED1 0%, #008B8B 100%);
        }
        .gradient-btn:hover {
            background: linear-gradient(135deg, #008B8B 0%, #006666 100%);
        }
        .input-field {
            transition: all 0.3s ease;
            border: 2px solid #C8A2C8;
        }
        .input-field:focus {
            border-color: #9370DB;
            box-shadow: 0 0 0 3px rgba(200, 162, 200, 0.2);
        }
        .question-item {
            background-color: rgba(255, 255, 255, 0.8);
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            position: relative;
        }
        .remove-question {
            position: absolute;
            right: 12px;
            top: 12px;
            color: #ef4444;
            cursor: pointer;
        }
        .question-count {
            background: #9370DB;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            font-size: 12px;
            font-weight: 600;
        }
    </style>
</head>
<body class="p-6">
    <div class="max-w-2xl mx-auto">
        <!-- Header with DUF Tech Logo -->
        <div class="text-center mb-8">
            <img src="{{ url_for('static', filename='duftech-interlocked-3d.svg') }}"
                alt="DUF Tech Logo"
                class="duftech-logo mx-auto mb-4">
            <h1 class="text-3xl font-bold mb-2">Mülakat Oluştur</h1>
            <p class="text-gray-600">Yeni bir mülakat oturumu yapılandırın.</p>
        </div>

        <!-- Mülakat Oluşturma Formu -->
        <div class="glassmorphism rounded-2xl p-8">
            <div class="space-y-6">
                <div>
                    <label for="candidateName" class="block text-sm font-medium text-gray-700 mb-2">
                        Aday Adı
                    </label>
                    <input type="text" 
                           id="candidateName" 
                           class="w-full px-4 py-3 rounded-xl input-field
                                  text-gray-700"
                           placeholder="Adı Soyadı">
                </div>

                <div>
                    <label for="position" class="block text-sm font-medium text-gray-700 mb-2">
                        Pozisyon
                    </label>
                    <div class="mb-2">
                        <select id="position-selector" class="w-full px-4 py-3 rounded-xl input-field text-gray-700">
                            <option value="">Pozisyon Seçin</option>
                            <!-- Pozisyonlar JS ile yüklenecek -->
                            <option value="custom">Diğer (Manuel Giriş)</option>
                        </select>
                    </div>
                    <div id="custom-position-div" class="hidden">
                        <input type="text" 
                               id="position" 
                               class="w-full px-4 py-3 rounded-xl input-field text-gray-700"
                               placeholder="Başvurulan Pozisyonu Girin">
                    </div>
                    <p class="mt-1 text-xs text-gray-500">Pozisyon adı, otomatik oluşturulacak soruların şekillenmesini sağlayacaktır.</p>
                </div>

                <div>
                    <label for="cvUpload" class="block text-sm font-medium text-gray-700 mb-2">
                        CV Yükle <span class="text-xs text-gray-500">(PDF, DOCX)</span>
                    </label>
                    <div class="relative">
                        <input type="file" 
                               id="cvUpload" 
                               class="hidden"
                               accept=".pdf,.docx,.doc">
                        <label for="cvUpload" 
                               class="w-full px-4 py-3 rounded-xl border-2 border-dashed border-purple-300 
                                     text-gray-700 cursor-pointer flex items-center justify-center 
                                     hover:bg-purple-50 transition-colors">
                            <i class="fas fa-file-upload mr-2 text-purple-500"></i>
                            <span id="fileNameDisplay">CV dosyasını sürükleyin veya seçin</span>
                        </label>
                    </div>
                    <div id="cvAnalysisStatus" class="mt-2 text-sm hidden">
                        <div class="flex items-center">
                            <i class="fas fa-spinner fa-spin mr-2 text-purple-600"></i>
                            <span>CV analiz ediliyor...</span>
                        </div>
                    </div>
                </div>
                
                <!-- CV Özeti -->
                <div id="cvSummaryContainer" class="hidden">
                    <div class="bg-purple-50 rounded-xl p-4 border border-purple-200">
                        <h3 class="text-sm font-medium text-purple-800 mb-2 flex items-center">
                            <i class="fas fa-file-alt mr-2"></i> CV Analiz Sonucu
                        </h3>
                        <div id="cvSummary" class="text-sm text-purple-700 space-y-2">
                            <!-- CV analiz sonucu burada görünecek -->
                        </div>
                        
                        <!-- Pozisyon Uyum Analizi -->
                        <div class="mt-4">
                            <h4 class="text-sm font-medium text-purple-800 mb-2">Pozisyon Uyum Analizi</h4>
                            <div id="matchAnalysis" class="space-y-2">
                                <!-- Uyum analizi burada görünecek -->
                            </div>
                        </div>
                        
                        <!-- Mülakat Soruları - CV Analizine Göre -->
                        <div class="mt-4" id="cvBasedQuestionsContainer">
                            <h4 class="text-sm font-medium text-purple-800 mb-2">Otomatik Oluşturulan Sorular</h4>
                            <div class="bg-white rounded-lg p-3 border border-purple-100">
                                <ul id="cvBasedQuestions" class="list-disc ml-5 space-y-2 text-sm">
                                    <!-- Otomatik sorular burada görünecek -->
                                </ul>
                            </div>
                        </div>
                        
                        <div class="mt-4 text-center">
                            <button id="useAutoQuestionsBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                <i class="fas fa-check mr-2"></i>Bu Soruları Kullan
                            </button>
                            <button id="continueToInterviewBtn" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors ml-2">
                                <i class="fas fa-arrow-right mr-2"></i>Mülakata Devam Et
                            </button>
                            <button id="createQuizFromCVBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors mt-3">
                                <i class="fas fa-question-circle mr-2"></i>Çoktan Seçmeli Sınav Oluştur
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Soru Yönetimi Bölümü -->
                <div class="mt-6">
                    <div class="flex items-center justify-between mb-4">
                        <label class="block text-sm font-medium text-gray-700">
                            Mülakat Soruları
                        </label>
                        <div>
                            <label for="useCustomQuestions" class="inline-flex items-center text-sm text-gray-600 mr-4">
                                <input type="checkbox" id="useCustomQuestions" class="mr-2"> 
                                Özel Sorular Kullan
                            </label>
                            <label for="maxQuestions" class="inline-flex items-center text-sm text-gray-600">
                                <span class="mr-2">Soru Sayısı:</span>
                                <select id="maxQuestions" class="px-2 py-1 rounded border input-field">
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5" selected>5</option>
                                    <option value="6">6</option>
                                    <option value="7">7</option>
                                    <option value="8">8</option>
                                </select>
                            </label>
                        </div>
                    </div>
                    
                    <div id="customQuestionsContainer" class="hidden space-y-4 mb-6">
                        <p class="text-sm text-gray-600">
                            Aşağıya kendi sorularınızı ekleyebilirsiniz. Eğer boş bırakırsanız, sistem otomatik olarak pozisyona uygun sorular oluşturacaktır.
                        </p>
                        <div id="questionsList" class="mb-4">
                            <!-- Sorular JavaScript ile eklenecek -->
                        </div>
                        <button type="button" id="addQuestionBtn" 
                                class="text-teal-600 hover:text-teal-800 flex items-center text-sm">
                            <i class="fas fa-plus-circle mr-2"></i> Soru Ekle
                        </button>
                    </div>
                </div>

                <div class="text-center mt-6">
                    <button onclick="createInterview()" 
                            class="gradient-btn text-white py-3 px-6 rounded-lg shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center mx-auto">
                        <i class="fas fa-plus-circle text-2xl mr-2"></i>
                        <span>Mülakat Oluştur</span>
                    </button>
                </div>

                <div class="text-center">
                    <a href="/join" class="text-teal-600 hover:text-teal-800 transition-colors">
                        <i class="fas fa-link mr-2"></i>
                        Mülakata Katıl
                    </a>
                    <span class="mx-2 text-gray-400">|</span>
                    <a href="/quiz_entry" class="text-purple-600 hover:text-purple-800 transition-colors">
                        <i class="fas fa-clipboard-list mr-2"></i>
                        Sınava Katıl
                    </a>
                </div>

                <div id="interviewDetails" class="hidden">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Mülakat Detayları</h3>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-600 mb-2">
                            Mülakat Kodu
                        </label>
                        <div class="flex items-center space-x-2">
                            <input type="text" 
                                   id="interviewCode" 
                                   class="flex-1 px-4 py-3 rounded-xl input-field
                                          bg-gray-50 text-gray-700" 
                                   readonly>
                            <button onclick="copyToClipboard('interviewCode')" 
                                    class="p-3 text-teal-600 hover:text-teal-800 
                                           rounded-xl hover:bg-teal-50 transition-colors">
                                <i class="fas fa-copy text-xl"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">
                            Mülakat Linki
                        </label>
                        <div class="flex items-center space-x-2">
                            <input type="text" 
                                   id="interviewLink" 
                                   class="flex-1 px-4 py-3 rounded-xl input-field
                                          bg-gray-50 text-gray-700" 
                                   readonly>
                            <button onclick="copyToClipboard('interviewLink')" 
                                    class="p-3 text-teal-600 hover:text-teal-800 
                                           rounded-xl hover:bg-teal-50 transition-colors">
                                <i class="fas fa-copy text-xl"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Çoktan Seçmeli Soru Oluşturma -->
                    <div class="mt-6 p-4 border border-purple-200 rounded-xl bg-purple-50">
                        <h4 class="text-lg font-semibold text-purple-800 mb-3">Çoktan Seçmeli Sorular</h4>
                        
                        <p class="text-sm text-gray-600 mb-4">
                            Bu pozisyon için çoktan seçmeli teknik sorular oluşturabilirsiniz. 
                            Sorular pozisyona özel olarak hazırlanacaktır.
                        </p>
                        
                        <div class="flex items-center mb-3">
                            <label class="text-sm font-medium text-gray-700 mr-3">Soru Sayısı:</label>
                            <select id="questionCount" class="px-3 py-2 rounded input-field text-gray-700">
                                <option value="5">5 Soru</option>
                                <option value="10" selected>10 Soru</option>
                                <option value="15">15 Soru</option>
                                <option value="20">20 Soru</option>
                            </select>
                        </div>
                        
                        <button id="createQuizBtn" 
                                class="w-full py-2 bg-purple-600 text-white rounded-lg 
                                       hover:bg-purple-700 transition-colors flex items-center justify-center">
                            <i class="fas fa-question-circle mr-2"></i>
                            Çoktan Seçmeli Sınav Oluştur
                        </button>
                        
                        <div id="quizLinkContainer" class="mt-4 hidden">
                            <label class="block text-sm font-medium text-gray-600 mb-2">
                                Sınav Linki
                            </label>
                            <div class="flex items-center space-x-2">
                                <input type="text" 
                                       id="quizLink" 
                                       class="flex-1 px-4 py-2 rounded-xl input-field
                                              bg-gray-50 text-gray-700" 
                                       readonly>
                                <button onclick="copyToClipboard('quizLink')" 
                                        class="p-2 text-purple-600 hover:text-purple-800 
                                               rounded-xl hover:bg-purple-50 transition-colors">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Başlat Butonu -->
                    <div class="text-center mt-6">
                        <button onclick="startInterview()" 
                                class="gradient-btn text-white px-8 py-3 rounded-xl 
                                       hover:shadow-xl transition-all duration-300">
                            <i class="fas fa-play mr-2"></i>
                            Mülakatı Başlat
                        </button>
                    </div>
                </div>
            </div>

            <!-- Sonuç Kutusu -->
            <div id="resultBox" class="mt-8 p-6 rounded-xl border-2 border-purple-200 hidden">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Mülakat Oluşturuldu</h3>
                <div class="space-y-4">
                    <!-- Mülakat Soruları -->
                    <div class="mb-6">
                        <h4 class="text-md font-medium text-gray-700 mb-2">Mülakat Soruları</h4>
                        <div id="resultsQuestionsList" class="space-y-2 bg-gray-50 p-4 rounded-lg">
                            <!-- Sorular JavaScript ile eklenecek -->
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">
                            Mülakat Kodu
                        </label>
                        <div class="flex items-center space-x-2">
                            <input type="text" 
                                   id="interviewCode" 
                                   class="flex-1 px-4 py-3 rounded-xl input-field
                                          bg-gray-50 text-gray-700 font-mono text-lg uppercase" 
                                   readonly>
                            <button onclick="copyToClipboard('interviewCode')" 
                                    class="p-3 text-teal-600 hover:text-teal-800 
                                           rounded-xl hover:bg-teal-50 transition-colors">
                                <i class="fas fa-copy text-xl"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">
                            Mülakat Linki
                        </label>
                        <div class="flex items-center space-x-2">
                            <input type="text" 
                                   id="interviewLink" 
                                   class="flex-1 px-4 py-3 rounded-xl input-field
                                          bg-gray-50 text-gray-700" 
                                   readonly>
                            <button onclick="copyToClipboard('interviewLink')" 
                                    class="p-3 text-teal-600 hover:text-teal-800 
                                           rounded-xl hover:bg-teal-50 transition-colors">
                                <i class="fas fa-copy text-xl"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Başlat Butonu -->
                    <div class="text-center mt-6">
                        <button onclick="startInterview()" 
                                class="gradient-btn text-white px-8 py-3 rounded-xl 
                                       hover:shadow-xl transition-all duration-300">
                            <i class="fas fa-play mr-2"></i>
                            Mülakatı Başlat
                        </button>
                    </div>
                </div>
            </div>

            <!-- Hata Mesajı -->
            <div id="errorBox" class="mt-4 p-4 rounded-lg bg-red-100 text-red-700 hidden"></div>
        </div>
    </div>

    <script>
        let customQuestions = [];
        let questionCounter = 1;

        document.addEventListener('DOMContentLoaded', function() {
            // Özel soru checkbox olayı
            const useCustomQuestionsCheckbox = document.getElementById('useCustomQuestions');
            const customQuestionsContainer = document.getElementById('customQuestionsContainer');
            
            useCustomQuestionsCheckbox.addEventListener('change', function() {
                customQuestionsContainer.classList.toggle('hidden', !this.checked);
                if (this.checked && document.querySelectorAll('#questionsList .question-item').length === 0) {
                    addQuestion(); // İlk soruyu otomatik ekle
                }
            });
            
            // Soru ekle butonu
            document.getElementById('addQuestionBtn').addEventListener('click', addQuestion);
            
            // Form submit listener
            document.querySelector('.gradient-btn').addEventListener('click', function(e) {
                e.preventDefault();
                createInterview();
            });

            // Çoktan seçmeli quiz oluşturma
            const createQuizBtn = document.getElementById('createQuizBtn');
            if (createQuizBtn) {
                createQuizBtn.addEventListener('click', createMultipleChoiceQuiz);
            }
            
            // CV ile quiz oluşturma butonu tıklama
            const createQuizFromCVBtn = document.getElementById('createQuizFromCVBtn');
            if (createQuizFromCVBtn) {
                createQuizFromCVBtn.addEventListener('click', function() {
                    // CV var mı kontrol et
                    if (!window.cvData) {
                        showError('Lütfen önce CV yükleyin.');
                        return;
                    }
                    
                    createMultipleChoiceQuiz();
                });
            }
            
            // "Bu Soruları Kullan" butonu
            document.getElementById('useAutoQuestionsBtn').addEventListener('click', function() {
                if (!window.autoQuestions || window.autoQuestions.length === 0) {
                    showError('Otomatik oluşturulan sorular bulunamadı');
                    return;
                }
                
                useAutoGeneratedQuestions(window.autoQuestions);
            });
            
            // "Mülakata Devam Et" butonu
            document.getElementById('continueToInterviewBtn').addEventListener('click', function() {
                if (!window.cvData) {
                    showError('CV analiz sonuçları bulunamadı');
                    return;
                }
                
                // Doğrudan mülakat oluştur
                createInterviewWithCVData();
            });

            // Pozisyon seçici ve özel pozisyon girişi
            const positionSelector = document.getElementById('position-selector');
            const customPositionDiv = document.getElementById('custom-position-div');
            const positionInput = document.getElementById('position');

            // LocalStorage'dan pozisyonları yükleme
            function loadPositionsToDropdown() {
                const savedPositions = localStorage.getItem('duftech_positions');
                
                if (savedPositions) {
                    try {
                        const positions = JSON.parse(savedPositions);
                        
                        // Mevcut seçenekleri koruyarak yeni pozisyonları ekleyelim
                        // Önce mevcut pozisyonları temizleyelim (ilk ve son seçeneği koruyarak)
                        const firstOption = positionSelector.firstElementChild;
                        const lastOption = positionSelector.lastElementChild;
                        positionSelector.innerHTML = '';
                        positionSelector.appendChild(firstOption);
                        
                        // Pozisyonları ekleyelim
                        positions.forEach(position => {
                            const option = document.createElement('option');
                            option.value = position.name;
                            option.textContent = `${position.name} (${position.department})`;
                            positionSelector.appendChild(option);
                        });
                        
                        // "Diğer" seçeneğini tekrar ekleyelim
                        positionSelector.appendChild(lastOption);
                    } catch (error) {
                        console.error('Pozisyonlar yüklenirken hata oluştu:', error);
                    }
                }
            }

            // Pozisyon seçici değiştiğinde
            positionSelector.addEventListener('change', function() {
                if (this.value === 'custom') {
                    customPositionDiv.classList.remove('hidden');
                    positionInput.focus();
                    positionInput.value = ''; // Özel girişi temizleyelim
                } else {
                    customPositionDiv.classList.add('hidden');
                    positionInput.value = this.value; // Seçilen değeri gizli input'a yazalım
                }
            });

            // Sayfa yüklendiğinde pozisyonları yükleyelim
            loadPositionsToDropdown();
        });
        
        // CV verilerini kullanarak mülakat oluştur
        function createInterviewWithCVData() {
            // Form verilerini al
            const candidateName = document.getElementById('candidateName').value.trim() || window.cvData.personal_info?.name || '';
            const position = getSelectedPosition(); // Güncellenmiş pozisyon alma yöntemi
            
            if (!candidateName || !position) {
                showError('Lütfen aday adı ve pozisyon giriniz.');
                return;
            }
            
            // Otomatik soruları kullan
            const questionsToUse = window.autoQuestions || [];
            
            // Yükleniyor mesajı göster
            Swal.fire({
                title: 'Mülakat Oluşturuluyor',
                text: 'Lütfen bekleyin...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // Mülakat oluştur
            fetch('/create_interview', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    candidate_name: candidateName,
                    position: position,
                    custom_questions: questionsToUse,
                    cv_data: window.cvData
                })
            })
            .then(response => response.json())
            .then(data => {
                Swal.close();
                
                if (data.success) {
                    // Mülakat detaylarını göster
                    document.getElementById('interviewCode').value = data.interview_code;
                    document.getElementById('interviewLink').value = window.location.origin + '/interview?code=' + data.interview_code;
                    document.getElementById('interviewDetails').classList.remove('hidden');
                    window.interviewCode = data.interview_code;
                    
                    // Başarı mesajı göster
                    Swal.fire({
                        title: 'Mülakat Oluşturuldu!',
                        text: 'Mülakat başarıyla oluşturuldu. Kodu ve linki adaya iletebilirsiniz.',
                        icon: 'success',
                        confirmButtonText: 'Tamam'
                    });
                } else {
                    showError(data.error || 'Mülakat oluşturulurken bir hata oluştu.');
                }
            })
            .catch(error => {
                Swal.close();
                console.error('Mülakat oluşturma hatası:', error);
                showError('Mülakat oluşturulurken bir hata oluştu.');
            });
        }
        
        // Otomatik oluşturulan soruları kullan
        function useAutoGeneratedQuestions(questions) {
            if (!questions || questions.length === 0) return;
            
            // Özel sorular checkbox'ı aktifleştir
            document.getElementById('useCustomQuestions').checked = true;
            document.getElementById('customQuestionsContainer').classList.remove('hidden');
            
            // Mevcut soruları temizle
            document.getElementById('questionsList').innerHTML = '';
            questionCounter = 1;
            
            // Otomatik oluşturulan soruları ekle
            questions.forEach(question => {
                const questionsList = document.getElementById('questionsList');
                const questionItem = document.createElement('div');
                questionItem.className = 'question-item';
                questionItem.innerHTML = `
                    <div class="flex items-center">
                        <span class="question-count">${questionCounter}</span>
                        <textarea 
                            class="w-full px-3 py-2 rounded input-field text-gray-700 pr-10" 
                            rows="2"
                        >${question}</textarea>
                        <span class="remove-question" onclick="removeQuestion(this)">
                            <i class="fas fa-times"></i>
                        </span>
                    </div>
                `;
                questionsList.appendChild(questionItem);
                questionCounter++;
            });
            
            // Soru kısmına scrolla
            document.getElementById('customQuestionsContainer').scrollIntoView({ behavior: 'smooth' });
            
            // Başarı mesajı göster
            Swal.fire({
                title: 'Sorular Eklendi',
                text: 'Otomatik oluşturulan sorular başarıyla eklendi.',
                icon: 'success',
                confirmButtonText: 'Tamam'
            });
        }
        
        // Çoktan seçmeli quiz oluşturma
        function createMultipleChoiceQuiz() {
            const position = getSelectedPosition(); // Güncellenmiş pozisyon alma yöntemi
            
            if (!position) {
                showError('Lütfen pozisyon bilgisi giriniz.');
                return;
            }
            
            // Mülakat kodu kontrolü
            const interviewCode = document.getElementById('interviewCode').value.trim();
            if (!interviewCode) {
                Swal.fire({
                    title: 'Mülakat Oluşturulmalı',
                    text: 'Çoktan seçmeli sınav oluşturmak için önce mülakat oluşturulmalıdır. Devam etmek istiyor musunuz?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Evet, Oluştur',
                    cancelButtonText: 'İptal'
                }).then((result) => {
                    if (result.isConfirmed) {
                        createInterviewThenQuiz();
                    }
                });
                return;
            }
            
            // Quiz türü seçimi için SweetAlert2 modal penceresi
            Swal.fire({
                title: 'Çoktan Seçmeli Sınav Oluştur',
                html: `
                    <p class="mb-4 text-sm text-gray-600">Bu pozisyon için çoktan seçmeli sınav oluşturulacak. Nasıl soru oluşturmak istersiniz?</p>
                    <div class="flex flex-col gap-3 text-left">
                        <div>
                            <input type="radio" id="position-only" name="quiz-type" value="position" class="mr-2" checked>
                            <label for="position-only" class="text-base text-gray-800">Sadece pozisyona göre soru oluştur</label>
                            <p class="ml-6 text-sm text-gray-600">Pozisyon için genel teknik sorular oluşturulur.</p>
                        </div>
                        ${window.cvData ? `
                        <div>
                            <input type="radio" id="cv-only" name="quiz-type" value="cv" class="mr-2">
                            <label for="cv-only" class="text-base text-gray-800">Sadece CV'ye göre soru oluştur</label>
                            <p class="ml-6 text-sm text-gray-600">Adayın CV'sindeki beceri ve deneyimlerine göre kişiselleştirilmiş sorular oluşturulur.</p>
                        </div>
                        <div>
                            <input type="radio" id="both" name="quiz-type" value="both" class="mr-2">
                            <label for="both" class="text-base text-gray-800">Hem CV hem pozisyona göre soru oluştur</label>
                            <p class="ml-6 text-sm text-gray-600">Hem pozisyon gereksinimlerine hem de CV'deki bilgilere göre dengeli sorular oluşturulur.</p>
                        </div>
                        ` : ''}
                    </div>
                    <div class="mt-4 text-left">
                        <label for="question-count-select" class="block text-base text-gray-800 mb-1">Soru Sayısı:</label>
                        <select id="question-count-select" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            <option value="5">5 Soru</option>
                            <option value="10" selected>10 Soru</option>
                            <option value="15">15 Soru</option>
                            <option value="20">20 Soru</option>
                        </select>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Oluştur',
                cancelButtonText: 'İptal',
                preConfirm: () => {
                    const quizType = document.querySelector('input[name="quiz-type"]:checked').value;
                    const questionCount = document.getElementById('question-count-select').value;
                    return { quizType, questionCount };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    createQuizWithOptions(result.value.quizType, result.value.questionCount);
                }
            });
        }
        
        // Önce mülakat oluştur, sonra quiz
        function createInterviewThenQuiz() {
            const candidateName = document.getElementById('candidateName').value.trim() || window.cvData?.personal_info?.name || 'İsimsiz Aday';
            const position = getSelectedPosition(); // Güncellenmiş pozisyon alma yöntemi
            
            if (!position) {
                showError('Lütfen pozisyon bilgisi giriniz.');
                return;
            }
            
            // Yükleniyor göster
            Swal.fire({
                title: 'Mülakat ve Sınav Oluşturuluyor',
                text: 'Lütfen bekleyin...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // Pozisyon ve CV bilgilerini al
            fetch('/create_interview', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    candidate_name: candidateName,
                    position: position,
                    cv_data: window.cvData || {}
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Mülakat kodu sakla
                    window.interviewCode = data.interview_code;
                    
                    // Quiz tipi ve soru sayısını al
                    Swal.fire({
                        title: 'Sınav Tipi Seçin',
                        html: `
                            <p class="mb-4 text-sm text-gray-600">Bu pozisyon için çoktan seçmeli sınav oluşturulacak. Nasıl soru oluşturmak istersiniz?</p>
                            <div class="flex flex-col gap-3 text-left">
                                <div>
                                    <input type="radio" id="position-only-new" name="quiz-type-new" value="position" class="mr-2" checked>
                                    <label for="position-only-new" class="text-base text-gray-800">Sadece pozisyona göre soru oluştur</label>
                                    <p class="ml-6 text-sm text-gray-600">Pozisyon için genel teknik sorular oluşturulur.</p>
                                </div>
                                ${window.cvData ? `
                                <div>
                                    <input type="radio" id="cv-only-new" name="quiz-type-new" value="cv" class="mr-2">
                                    <label for="cv-only-new" class="text-base text-gray-800">Sadece CV'ye göre soru oluştur</label>
                                    <p class="ml-6 text-sm text-gray-600">Adayın CV'sindeki beceri ve deneyimlerine göre kişiselleştirilmiş sorular oluşturulur.</p>
                                </div>
                                <div>
                                    <input type="radio" id="both-new" name="quiz-type-new" value="both" class="mr-2">
                                    <label for="both-new" class="text-base text-gray-800">Hem CV hem pozisyona göre soru oluştur</label>
                                    <p class="ml-6 text-sm text-gray-600">Hem pozisyon gereksinimlerine hem de CV'deki bilgilere göre dengeli sorular oluşturulur.</p>
                                </div>
                                ` : ''}
                            </div>
                            <div class="mt-4 text-left">
                                <label for="question-count-select-new" class="block text-base text-gray-800 mb-1">Soru Sayısı:</label>
                                <select id="question-count-select-new" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="5">5 Soru</option>
                                    <option value="10" selected>10 Soru</option>
                                    <option value="15">15 Soru</option>
                                    <option value="20">20 Soru</option>
                                </select>
                            </div>
                        `,
                        showCancelButton: true,
                        confirmButtonText: 'Oluştur',
                        cancelButtonText: 'İptal',
                        preConfirm: () => {
                            const quizType = document.querySelector('input[name="quiz-type-new"]:checked').value;
                            const questionCount = document.getElementById('question-count-select-new').value;
                            return { quizType, questionCount };
                        }
                    }).then((quizResult) => {
                        if (quizResult.isConfirmed) {
                            // Yükleniyor göster
                            Swal.fire({
                                title: 'Sorular Oluşturuluyor',
                                text: 'Lütfen bekleyin, bu işlem biraz zaman alabilir...',
                                allowOutsideClick: false,
                                didOpen: () => {
                                    Swal.showLoading();
                                }
                            });
                            
                            // Quiz oluşturma isteği
                            fetch('/create_multiple_choice', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    position: position,
                                    question_count: quizResult.value.questionCount,
                                    interview_code: data.interview_code,
                                    quiz_type: quizResult.value.quizType,
                                    cv_data: quizResult.value.quizType !== 'position' ? window.cvData : null
                                })
                            })
                            .then(response => response.json())
                            .then(quizData => {
                                // Yükleniyor mesajını kapat
                                Swal.close();
                                
                                if (quizData.success) {
                                    // Mülakat ve sınav bilgilerini göster
                                    document.getElementById('interviewCode').value = data.interview_code;
                                    document.getElementById('interviewLink').value = window.location.origin + '/interview?code=' + data.interview_code;
                                    document.getElementById('interviewDetails').classList.remove('hidden');
                                    
                                    // Sınav linkini göster
                                    document.getElementById('quizLink').value = window.location.origin + quizData.quiz_url;
                                    document.getElementById('quizLinkContainer').classList.remove('hidden');
                                    
                                    // Başarı mesajı göster
                                    Swal.fire({
                                        title: 'Mülakat ve Sınav Oluşturuldu!',
                                        html: `
                                            Mülakat ve sınav başarıyla oluşturuldu.<br><br>
                                            <div class="text-left">
                                                <strong>Mülakat Kodu:</strong> ${data.interview_code}<br>
                                                <strong>Sınav Bağlantısı:</strong> <a href="${window.location.origin + quizData.quiz_url}" class="text-blue-600" target="_blank">${window.location.origin + quizData.quiz_url}</a>
                                            </div>
                                        `,
                                        icon: 'success',
                                        confirmButtonText: 'Tamam'
                                    });
                                } else {
                                    // Mülakat oluşturuldu ama sınav oluşturulamadı
                                    document.getElementById('interviewCode').value = data.interview_code;
                                    document.getElementById('interviewLink').value = window.location.origin + '/interview?code=' + data.interview_code;
                                    document.getElementById('interviewDetails').classList.remove('hidden');
                                    
                                    showError(quizData.error || 'Sınav oluşturulurken bir hata oluştu, ancak mülakat başarıyla oluşturuldu.');
                                }
                            })
                            .catch(error => {
                                Swal.close();
                                console.error('Sınav oluşturma hatası:', error);
                                showError('Sınav oluşturulurken bir hata oluştu, ancak mülakat başarıyla oluşturuldu.');
                            });
                        } else {
                            // Sadece mülakat oluşturuldu, quiz iptal edildi
                            document.getElementById('interviewCode').value = data.interview_code;
                            document.getElementById('interviewLink').value = window.location.origin + '/interview?code=' + data.interview_code;
                            document.getElementById('interviewDetails').classList.remove('hidden');
                            
                            Swal.fire({
                                title: 'Mülakat Oluşturuldu',
                                text: 'Sınav oluşturma iptal edildi, ancak mülakat başarıyla oluşturuldu.',
                                icon: 'info',
                                confirmButtonText: 'Tamam'
                            });
                        }
                    });
                } else {
                    Swal.close();
                    showError(data.error || 'Mülakat oluşturulurken bir hata oluştu.');
                }
            })
            .catch(error => {
                Swal.close();
                console.error('Mülakat oluşturma hatası:', error);
                showError('Mülakat oluşturulurken bir hata oluştu.');
            });
        }

        function addQuestion() {
            const questionsList = document.getElementById('questionsList');
            const questionItem = document.createElement('div');
            questionItem.className = 'question-item';
            questionItem.innerHTML = `
                <div class="flex items-center">
                    <span class="question-count">${questionCounter}</span>
                    <textarea 
                        class="w-full px-3 py-2 rounded input-field text-gray-700 pr-10" 
                        rows="2" 
                        placeholder="Sorunuzu buraya yazın..."
                    ></textarea>
                    <span class="remove-question" onclick="removeQuestion(this)">
                        <i class="fas fa-times"></i>
                    </span>
                </div>
            `;
            questionsList.appendChild(questionItem);
            questionCounter++;
            
            // Son eklenen textarea'ya odaklan
            const textareas = document.querySelectorAll('#questionsList textarea');
            if (textareas.length > 0) {
                textareas[textareas.length - 1].focus();
            }
        }
        
        function removeQuestion(element) {
            const questionItem = element.closest('.question-item');
            questionItem.remove();
            
            // Soru numaralarını güncelle
            const questionItems = document.querySelectorAll('#questionsList .question-item');
            questionItems.forEach((item, index) => {
                item.querySelector('.question-count').textContent = index + 1;
            });
            
            questionCounter = questionItems.length + 1;
        }

        function getCustomQuestions() {
            const useCustomQuestions = document.getElementById('useCustomQuestions').checked;
            if (!useCustomQuestions) return null;
            
            const questions = [];
            const textareas = document.querySelectorAll('#questionsList textarea');
            textareas.forEach(textarea => {
                const questionText = textarea.value.trim();
                if (questionText) {
                    questions.push(questionText);
                }
            });
            
            return questions.length > 0 ? questions : null;
        }

        function createInterview() {
            // Form verilerini al
            const candidateName = document.getElementById('candidateName').value.trim();
            const position = getSelectedPosition(); // Güncellenmiş pozisyon alma yöntemi
            const maxQuestions = 5; // Sabit soru sayısı
            
            // Soruları al
            let customQuestions = [];
            if (document.getElementById('useCustomQuestions').checked) {
                document.querySelectorAll('#questionsList .question-item textarea').forEach(textarea => {
                    const questionText = textarea.value.trim();
                    if (questionText) {
                        customQuestions.push(questionText);
                    }
                });
            }
            
            // Validasyon
            if (!candidateName || !position) {
                showError('Lütfen aday adı ve pozisyon giriniz.');
                return;
            }
            
            // CV verilerini al (eğer analiz edildiyse)
            const cvData = window.cvData || {};
            
            // AJAX isteği gönder
            fetch('/create_interview', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                body: JSON.stringify({
                    candidate_name: candidateName,
                    position: position,
                    max_questions: maxQuestions,
                    custom_questions: customQuestions,
                    cv_data: cvData
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Mülakat linkini ve kodunu görüntüle
                    document.getElementById('interviewCode').value = data.interview_code;
                    document.getElementById('interviewLink').value = window.location.origin + '/interview?code=' + data.interview_code;
                    
                    // Mülakat detaylarını göster
                    document.getElementById('interviewDetails').classList.remove('hidden');
                    
                    // Saklı bilgiyi güncelle
                    window.interviewCode = data.interview_code;
                    
                    // Quiz oluşturma seçeneği göster
                    if (data.show_quiz_option) {
                        Swal.fire({
                            title: 'CV Analizi Tamamlandı',
                            text: 'CV analizi başarıyla tamamlandı. Şimdi ne yapmak istersiniz?',
                            icon: 'success',
                            showCancelButton: true,
                            showDenyButton: true,
                            confirmButtonText: 'Mülakat Oluştur',
                            denyButtonText: 'Quiz Oluştur',
                            cancelButtonText: 'Sadece Analiz Göster'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                // Mülakat oluştur
                                createInterview();
                            } else if (result.isDenied) {
                                // Quiz oluşturma fonksiyonunu çağır
                                createMultipleChoiceQuiz();
                            }
                        });
                        
                        // Seçenekleri ayrıca ekranda butonlar olarak da göster
                        const actionButtons = document.createElement('div');
                        actionButtons.className = 'mt-4 flex flex-wrap gap-3 justify-center';
                        actionButtons.innerHTML = `
                            <button class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-full flex items-center" id="createInterviewBtn">
                                <i class="fas fa-user-tie mr-2"></i> Mülakat Oluştur
                            </button>
                            <button class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-full flex items-center" id="createQuizBtn">
                                <i class="fas fa-question-circle mr-2"></i> Çoktan Seçmeli Sınav Oluştur
                            </button>
                            <button class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-full flex items-center" id="useSuggestedQuestionsBtn">
                                <i class="fas fa-clipboard-list mr-2"></i> Önerilen Soruları Kullan
                            </button>
                        `;
                        
                        // Eğer zaten eklenmişse, ekleme
                        if (!document.getElementById('actionButtons')) {
                            actionButtons.id = 'actionButtons';
                            document.getElementById('cvSummaryContainer').appendChild(actionButtons);
                            
                            // Buton event listenerları
                            document.getElementById('createInterviewBtn').addEventListener('click', createInterview);
                            document.getElementById('createQuizBtn').addEventListener('click', createMultipleChoiceQuiz);
                            document.getElementById('useSuggestedQuestionsBtn').addEventListener('click', function() {
                                if (window.autoQuestions && window.autoQuestions.length > 0) {
                                    useAutoGeneratedQuestions(window.autoQuestions);
                                } else {
                                    showError('Önerilen sorular bulunamadı');
                                }
                            });
                        }
                    }
                    
                    // Global olarak CV verilerini sakla
                    window.cvData = data;
                    
                    // Başarı mesajı göster
                    Swal.fire({
                        title: 'Mülakat Oluşturuldu!',
                        text: 'Mülakat başarıyla oluşturuldu. Kodu ve linki adaya iletebilirsiniz.',
                        icon: 'success',
                        confirmButtonText: 'Tamam'
                    });
                } else {
                    showError(data.error || 'Mülakat oluşturulurken bir hata oluştu.');
                }
            })
            .catch(error => {
                console.error('Mülakat oluşturma hatası:', error);
                showError('Mülakat oluşturulurken bir hata oluştu.');
            });
        }
        
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            element.select();
            document.execCommand('copy');
            
            // Kopyalandı bildirimi
            const tooltip = document.createElement('div');
            tooltip.textContent = 'Kopyalandı!';
            tooltip.className = 'copy-tooltip';
            document.body.appendChild(tooltip);
            
            setTimeout(() => {
                document.body.removeChild(tooltip);
            }, 1500);
        }

        function showError(message) {
            const errorBox = document.getElementById('errorBox');
            errorBox.textContent = message;
            errorBox.classList.remove('hidden');
            
            setTimeout(() => {
                errorBox.classList.add('hidden');
            }, 5000);
        }

        async function startInterview() {
            const code = document.getElementById('interviewCode').value;
            if (!code) {
                showError('Mülakat kodu bulunamadı');
                return;
            }

            window.location.href = `/interview?code=${code}`;
        }

        // Enter tuşu ile form gönderme
        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    createInterview();
                }
            });
        });

        // CV Yükleme ve Analiz İşlemleri
        document.getElementById('cvUpload').addEventListener('change', function(e) {
            const fileName = e.target.files[0]?.name || 'CV dosyasını sürükleyin veya seçin';
            document.getElementById('fileNameDisplay').textContent = fileName;
            
            if (e.target.files.length > 0) {
                analyzeCv(e.target.files[0]);
            }
        });
        
        function analyzeCv(file) {
                const formData = new FormData();
                formData.append('cv_file', file);
            
            // Pozisyon değerini al
            const position = document.getElementById('position').value.trim();
                    formData.append('position', position);
            
            // Analiz durumunu göster
            document.getElementById('cvAnalysisStatus').classList.remove('hidden');
            
            fetch('/analyze_cv', {
                    method: 'POST',
                    body: formData
            })
            .then(response => response.json())
            .then(data => {
                // Konsola veriyi yazdır (hata ayıklama için)
                console.log("CV analizi cevabı:", data);
                
                // Analiz durumunu gizle
                document.getElementById('cvAnalysisStatus').classList.add('hidden');
                
                if (data.needs_position) {
                    // Pozisyon girişi isteğini göster
                    Swal.fire({
                        title: 'Pozisyon Belirtin',
                        text: data.message,
                        input: 'text',
                        inputPlaceholder: 'Pozisyon adını girin',
                        showCancelButton: true,
                        confirmButtonText: 'Analiz Et',
                        cancelButtonText: 'İptal',
                        inputValidator: (value) => {
                            if (!value) {
                                return 'Pozisyon adını girmelisiniz!';
                            }
                        }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // Pozisyon bilgisini güncelle ve yeniden analiz et
                            document.getElementById('position').value = result.value;
                            analyzeCv(file);
                        }
                    });
                    return;
                }
                
                if (data.success) {
                    // CV özeti konteynerini görünür yap
                    document.getElementById('cvSummaryContainer').classList.remove('hidden');
                    
                    // CV özeti göster
                    displayAnalysisResults(data);
                    
                    // CV verilerini global değişkene kaydet
                    window.cvData = data;
                    
                    // Eğer generatedQuestions varsa, bunları autoQuestions olarak işle
                    if (data.generated_questions && data.generated_questions.length > 0) {
                        window.autoQuestions = data.generated_questions;
                        
                        // Otomatik oluşturulan soruları göster
                        const cvBasedQuestions = document.getElementById('cvBasedQuestions');
                        cvBasedQuestions.innerHTML = '';
                        
                        data.generated_questions.forEach(question => {
                            const li = document.createElement('li');
                            li.className = 'text-gray-700';
                            li.textContent = question;
                            cvBasedQuestions.appendChild(li);
                        });
                        
                        // CV tabanlı sorular konteynerini görünür yap
                        document.getElementById('cvBasedQuestionsContainer').classList.remove('hidden');
                    }
                    
                    // Uyumluluk analizini göster (eğer pozisyon belirtilmişse)
                    if (position) {
                        analyzePositionMatch(data);
                    }
                    
                    // Quiz oluşturma seçeneği göster
                    if (data.show_quiz_option) {
                        Swal.fire({
                            title: 'CV Analizi Tamamlandı',
                            text: 'CV analizi başarıyla tamamlandı. Şimdi ne yapmak istersiniz?',
                            icon: 'success',
                            showCancelButton: true,
                            showDenyButton: true,
                            confirmButtonText: 'Mülakat Oluştur',
                            denyButtonText: 'Quiz Oluştur',
                            cancelButtonText: 'Sadece Analiz Göster'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                // Mülakat oluştur
                                createInterview();
                            } else if (result.isDenied) {
                                // Quiz oluşturma fonksiyonunu çağır
                                createMultipleChoiceQuiz();
                            }
                        });
                        
                        // Seçenekleri ayrıca ekranda butonlar olarak da göster
                        const actionButtons = document.createElement('div');
                        actionButtons.className = 'mt-4 flex flex-wrap gap-3 justify-center';
                        actionButtons.innerHTML = `
                            <button class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-full flex items-center" id="createInterviewBtn">
                                <i class="fas fa-user-tie mr-2"></i> Mülakat Oluştur
                            </button>
                            <button class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-full flex items-center" id="createQuizBtn">
                                <i class="fas fa-question-circle mr-2"></i> Çoktan Seçmeli Sınav Oluştur
                            </button>
                            <button class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-full flex items-center" id="useSuggestedQuestionsBtn">
                                <i class="fas fa-clipboard-list mr-2"></i> Önerilen Soruları Kullan
                            </button>
                        `;
                        
                        // Eğer zaten eklenmişse, ekleme
                        if (!document.getElementById('actionButtons')) {
                            actionButtons.id = 'actionButtons';
                            document.getElementById('cvSummaryContainer').appendChild(actionButtons);
                            
                            // Buton event listenerları
                            document.getElementById('createInterviewBtn').addEventListener('click', createInterview);
                            document.getElementById('createQuizBtn').addEventListener('click', createMultipleChoiceQuiz);
                            document.getElementById('useSuggestedQuestionsBtn').addEventListener('click', function() {
                                if (window.autoQuestions && window.autoQuestions.length > 0) {
                                    useAutoGeneratedQuestions(window.autoQuestions);
                                } else {
                                    showError('Önerilen sorular bulunamadı');
                                }
                            });
                        }
                    }
                } else {
                    // Hata mesajı göster
                    showError(data.error || 'CV analiz edilirken bir hata oluştu.');
                }
            })
            .catch(error => {
                console.error('CV analiz hatası:', error);
                document.getElementById('cvAnalysisStatus').classList.add('hidden');
                showError('CV analizi sırasında bir hata oluştu.');
            });
        }
        
        // CV analiz sonuçlarını göster
        function displayAnalysisResults(data) {
            // Analiz sonucunu göster
            document.getElementById('cvSummaryContainer').classList.remove('hidden');

            // CV özeti göster
            displayCvSummary(data);
            
            // Form'a veri doldur
            populateFormFromCV(data);
            
            // Pozisyon uyumluluğunu analiz et
            analyzePositionMatch(data);
            
            // Güçlü yönler ve geliştirilecek alanları göster (eğer varsa)
            if (data.strengths && data.strengths.length > 0 || 
                data.areas_to_improve && data.areas_to_improve.length > 0) {
                
                const strengthsHTML = `
                    <div class="mb-3">
                        <p class="font-medium text-purple-900">Güçlü Yönler</p>
                        <ul class="list-disc pl-5 mt-1 text-sm">
                            ${(data.strengths || []).map(strength => `<li>${strength}</li>`).join('')}
                        </ul>
                    </div>
                    
                    ${data.areas_to_improve && data.areas_to_improve.length > 0 ? `
                    <div class="mb-3">
                        <p class="font-medium text-purple-900">Geliştirilecek Alanlar</p>
                        <ul class="list-disc pl-5 mt-1 text-sm">
                            ${data.areas_to_improve.map(area => `<li>${area}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}
                `;
                
                // Özel bir alan oluştur veya mevcut bir alana ekle
                if (document.getElementById('strengthsAnalysis')) {
                    document.getElementById('strengthsAnalysis').innerHTML = strengthsHTML;
                } else {
                    const strengthsDiv = document.createElement('div');
                    strengthsDiv.id = 'strengthsAnalysis';
                    strengthsDiv.innerHTML = strengthsHTML;
                    document.getElementById('cvSummary').appendChild(strengthsDiv);
                }
            }
            
            // Global olarak CV verilerini sakla
            window.cvData = data;
        }

        // Mülakat detayları
        function displayInterviewDetails(data) {
            const detailsSection = document.getElementById('interviewDetails');
            if (!detailsSection) return;
            
            detailsSection.innerHTML = `
                <h2 class="text-lg font-semibold mb-2">Mülakat Detayları</h2>
                <p><strong>Mülakat Kodu</strong><br>${data.interview_code || 'Kod oluşturuluyor...'}</p>
            `;
            
            // Mülakat kodunu gizli input'a da ekle
            if (document.getElementById('interviewCode')) {
                document.getElementById('interviewCode').value = data.interview_code || '';
            }
            
            // Detay bölümünü görünür yap
            detailsSection.classList.remove('hidden');
        }

        function displayCvSummary(data) {
            // CV özeti konteynerini görünür yap
            document.getElementById('cvSummaryContainer').classList.remove('hidden');
            
            const summaryContainer = document.getElementById('cvSummary');
            summaryContainer.innerHTML = '';
            
            // Kişisel bilgiler
            const personalInfo = data.personal_info || {};
            const fullName = personalInfo.name || '';
            const email = personalInfo.email || '';
            const phone = personalInfo.phone || '';
            const location = personalInfo.location || '';
            
            // Özet
            const summary = data.summary || 'Özet bilgisi bulunamadı';
            
            // Deneyim özeti
            const experience = data.experience || [];
            const skills = data.skills || [];
            const education = data.education || [];
            const languages = data.languages || [];
            const certificates = data.certificates || [];
            
            // Özet bilgileri oluştur
            const summaryHTML = `
                <div class="mb-3 p-3 bg-white rounded-lg border border-purple-100">
                    <p class="font-medium text-purple-900">Kişisel Bilgiler</p>
                    <div class="grid grid-cols-2 gap-2 mt-1 text-sm">
                        <div><span class="font-medium">Ad Soyad:</span> ${fullName}</div>
                        <div><span class="font-medium">E-posta:</span> ${email}</div>
                        <div><span class="font-medium">Telefon:</span> ${phone}</div>
                        <div><span class="font-medium">Konum:</span> ${location}</div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <p class="font-medium text-purple-900">Profil Özeti</p>
                    <p class="text-sm mt-1">${data.profile_summary || summary}</p>
                </div>
                
                <div class="mb-3">
                    <p class="font-medium text-purple-900">Beceriler</p>
                    <div class="flex flex-wrap gap-1 mt-1">
                        ${skills.map(skill => `
                            <span class="bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded">
                                ${skill}
                            </span>
                        `).join('')}
                    </div>
                </div>
                
                <div class="mb-3">
                    <p class="font-medium text-purple-900">Deneyim</p>
                    <ul class="list-disc pl-5 mt-1">
                        ${experience.map(exp => `
                            <li>
                                <span class="font-medium">${exp.title || ''}</span> 
                                ${exp.company ? '- ' + exp.company : ''} 
                                ${exp.duration ? '(' + exp.duration + ')' : ''}
                            </li>
                        `).join('')}
                    </ul>
                </div>
                
                <div>
                    <p class="font-medium text-purple-900">Eğitim</p>
                    <ul class="list-disc pl-5 mt-1">
                        ${education.map(edu => `
                            <li>
                                <span class="font-medium">${edu.degree || ''}</span> 
                                ${edu.institution ? '- ' + edu.institution : ''} 
                                ${edu.year ? '(' + edu.year + ')' : ''}
                            </li>
                        `).join('')}
                    </ul>
                </div>
                
                ${languages.length > 0 ? `
                <div class="mt-3">
                    <p class="font-medium text-purple-900">Diller</p>
                    <p class="mt-1">${languages.join(', ')}</p>
                </div>
                ` : ''}
                
                ${certificates.length > 0 ? `
                <div class="mt-3">
                    <p class="font-medium text-purple-900">Sertifikalar</p>
                    <ul class="list-disc pl-5 mt-1">
                        ${certificates.map(cert => `<li>${cert}</li>`).join('')}
                    </ul>
                </div>
                ` : ''}
            `;
            
            summaryContainer.innerHTML = summaryHTML;
            
            // CV içeriğine göre formu doldur
            if (fullName) {
                document.getElementById('candidateName').value = fullName;
            }
            
            // Pozisyon bilgisini doldur (eğer daha önce bir değer girildiyse değiştirme)
            const positionInput = document.getElementById('position');
            const positionSelector = document.getElementById('position-selector');

            if ((!positionInput.value || positionInput.value === '') && cvData.experience && cvData.experience.length > 0) {
                const detectedPosition = cvData.experience[0].title || '';
                
                // Önce dropdown listesinde bu pozisyon var mı kontrol et
                let positionFound = false;
                for (let i = 0; i < positionSelector.options.length; i++) {
                    if (positionSelector.options[i].value.toLowerCase() === detectedPosition.toLowerCase()) {
                        positionSelector.selectedIndex = i;
                        positionInput.value = detectedPosition;
                        positionFound = true;
                        break;
                    }
                }
                
                // Eğer pozisyon dropdown'da bulunamadıysa, "Diğer" seçeneğini seç ve manuel giriş yap
                if (!positionFound && detectedPosition) {
                    // "Diğer" seçeneğini seç
                    for (let i = 0; i < positionSelector.options.length; i++) {
                        if (positionSelector.options[i].value === 'custom') {
                            positionSelector.selectedIndex = i;
                            break;
                        }
                    }
                    
                    // Manuel giriş alanını göster ve değeri ata
                    document.getElementById('custom-position-div').classList.remove('hidden');
                    positionInput.value = detectedPosition;
                }
            }
        }
        
        function populateFormFromCV(cvData) {
            // Kişisel bilgileri formda doldur
            const personalInfo = cvData.personal_info || {};
            
            // İsim bilgisini doldur
            if (personalInfo.name) {
                document.getElementById('candidateName').value = personalInfo.name;
            }
            
            // Pozisyon bilgisini doldur (eğer daha önce bir değer girildiyse değiştirme)
            const positionInput = document.getElementById('position');
            if (!positionInput.value && cvData.experience && cvData.experience.length > 0) {
                positionInput.value = cvData.experience[0].title || '';
            }
        }
        
        function analyzePositionMatch(data) {
            const position = getSelectedPosition(); // Güncellenmiş pozisyon alma yöntemi
            
            if (!position) {
                document.getElementById('matchAnalysis').innerHTML = '<p class="text-amber-600">Pozisyon adını girin, bir uyumluluk analizi yapmak için.</p>';
                return;
            }
            
            // Position match özellikle kontrol edilebilir
            if (data.position_match && typeof data.position_match.match_percentage === 'number') {
                displayPositionMatchFromAPI(data.position_match, position);
                return;
            }
            
            // Basit bir pozisyon eşleşmesi hesaplayalım
            const skills = data.skills || [];
            const allSkillsText = skills.join(' ').toLowerCase();
            
            const positionKeywords = position.toLowerCase().split(/\s+/).filter(word => word.length > 3);
            
            // Eğer pozisyon anahtar kelimeleri bulunamazsa, varsayılan anahtar kelimeler kullan
            if (positionKeywords.length === 0) {
                positionKeywords.push('developer', 'engineer', 'specialist');
            }
            
            // Pozisyonla eşleşen beceriler
            const matchingSkills = skills.filter(skill => 
                positionKeywords.some(keyword => skill.toLowerCase().includes(keyword))
            );
            
            // Uyum yüzdesi
            let matchPercentage = 0;
            
            // Eğer CV'deki herhangi bir beceri pozisyon ile eşleşiyorsa, temel bir uyum vardır
            if (positionKeywords.some(keyword => allSkillsText.includes(keyword))) {
                matchPercentage = 50; // Temel uyum
                
                // Eşleşen beceri sayısına göre uyum yüzdesini artıralım
                if (matchingSkills.length > 0) {
                    matchPercentage += Math.min(50, matchingSkills.length * 10); // Her eşleşen beceri %10 ekler, maksimum %100
                }
            } else {
                // Basit eşleşme: Deneyimdeki anahtar kelimeleri kontrol et
                const experiences = data.experience || [];
                const experienceTexts = experiences.map(exp => `${exp.title} ${exp.company} ${exp.description}`).join(' ').toLowerCase();
                
                if (positionKeywords.some(keyword => 
                    experienceTexts.includes(keyword)
                )) {
                    matchPercentage = 30; // Deneyimde bir eşleşme var
                }
            }
            
            // Eşleşmeyi göster
            displayPositionMatch(matchPercentage, matchingSkills, positionKeywords);
        }
        
        function displayPositionMatchFromAPI(positionMatch, position) {
            // API'den gelen pozisyon uyum bilgisini göster
            const matchPercentage = positionMatch.match_percentage || 0;
            const matchingSkills = positionMatch.matching_skills || [];
            const missingSkills = positionMatch.missing_skills || [];
            const recommendations = positionMatch.recommendations || [];
            
            let matchHTML = `
                <div class="p-3 bg-white rounded-lg border border-purple-100">
                    <div class="flex items-center justify-between mb-2">
                        <p class="font-medium">Pozisyon Uyumu</p>
                        <div class="flex items-center">
                            <div class="w-24 h-3 bg-gray-200 rounded-full mr-2">
                                <div class="h-full rounded-full ${matchPercentage > 70 ? 'bg-green-500' : matchPercentage > 40 ? 'bg-yellow-500' : 'bg-red-500'}" 
                                     style="width: ${matchPercentage}%"></div>
                            </div>
                            <span class="text-sm font-medium ${matchPercentage > 70 ? 'text-green-700' : matchPercentage > 40 ? 'text-yellow-700' : 'text-red-700'}">
                                %${matchPercentage}
                            </span>
                        </div>
                    </div>
                    
                    <div class="text-sm">
                        <p>
                            <span class="font-medium">Eşleşen Beceriler:</span> 
                            ${matchingSkills.length > 0 ? matchingSkills.join(', ') : 'Eşleşen beceri bulunamadı.'}
                        </p>
                        
                        ${missingSkills.length > 0 ? `
                        <p class="mt-1">
                            <span class="font-medium">Eksik Beceriler:</span> 
                            ${missingSkills.join(', ')}
                        </p>
                        ` : ''}
                        
                        ${recommendations.length > 0 ? `
                        <p class="mt-1">
                            <span class="font-medium">Öneriler:</span>
                            <ul class="list-disc ml-5 mt-1">
                                ${recommendations.map(rec => `<li>${rec}</li>`).join('')}
                            </ul>
                        </p>
                        ` : ''}
                        
                        <p class="mt-2 ${matchPercentage > 70 ? 'text-green-700' : matchPercentage > 40 ? 'text-yellow-700' : 'text-red-700'}">
                            <i class="fas ${matchPercentage > 70 ? 'fa-check-circle' : matchPercentage > 40 ? 'fa-info-circle' : 'fa-exclamation-circle'} mr-1"></i>
                            ${matchPercentage > 70 ? 
                                'Aday pozisyon için çok uygun görünüyor.' : 
                                matchPercentage > 40 ? 
                                'Aday pozisyon için potansiyel uygunlukta.' : 
                                'Aday pozisyon için uygunluğu düşük olabilir.'}
                        </p>
                    </div>
                </div>
            `;
            
            document.getElementById('matchAnalysis').innerHTML = matchHTML;
        }

        // Çoktan seçmeli quiz oluşturma
        function createQuizWithOptions(quizType, questionCount) {
            const position = document.getElementById('position').value.trim();
            const interviewCode = document.getElementById('interviewCode').value.trim();
            
            if (!position) {
                showError('Lütfen pozisyon bilgisi giriniz.');
                return;
            }
            
            if (quizType !== 'position' && !window.cvData) {
                showError('CV yüklenmeden CV bazlı soru oluşturulamaz.');
                return;
            }
            
            // Yükleniyor göster
            Swal.fire({
                title: 'Sorular Oluşturuluyor',
                text: 'Lütfen bekleyin, bu işlem biraz zaman alabilir...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // Quiz oluşturma isteği
            fetch('/create_multiple_choice', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                body: JSON.stringify({
                    position: position,
                    question_count: questionCount,
                    interview_code: interviewCode,
                    quiz_type: quizType,
                    cv_data: quizType !== 'position' ? window.cvData : null
                })
            })
            .then(response => response.json())
            .then(data => {
                // Yükleniyor mesajını kapat
                Swal.close();
                
                if (data.success) {
                    // Sınav linkini göster
                    if (document.getElementById('quizLink')) {
                        document.getElementById('quizLink').value = window.location.origin + data.quiz_url;
                        document.getElementById('quizLinkContainer').classList.remove('hidden');
                    }
                    
                    // Başarı mesajı göster
                    Swal.fire({
                        title: 'Sınav Oluşturuldu!',
                        html: `
                            ${data.message}<br><br>
                            <div class="text-left">
                                <strong>Sınava erişim:</strong><br>
                                - Sınav bağlantısı: <a href="${window.location.origin + data.quiz_url}" class="text-blue-600" target="_blank">${window.location.origin + data.quiz_url}</a><br>
                                - Veya <strong>"${interviewCode}"</strong> kodunu kullanarak quiz sayfasına giriş yapabilir.
                            </div>
                        `,
                        icon: 'success',
                        confirmButtonText: 'Tamam'
                    });
                } else {
                    showError(data.error || 'Sınav oluşturulurken bir hata oluştu.');
                }
            })
            .catch(error => {
                Swal.close();
                console.error('Sınav oluşturma hatası:', error);
                showError('Sınav oluşturulurken bir hata oluştu.');
            });
        }

        // Formu göndermeden önce pozisyon değerini kontrol edelim
        function getSelectedPosition() {
            if (positionSelector.value === 'custom') {
                return positionInput.value.trim();
            }
            return positionSelector.value;
        }

        // Mevcut form gönderme kodunu güncelle
        document.getElementById('createInterviewForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const candidateName = document.getElementById('candidateName').value.trim();
            const position = getSelectedPosition();
            
            if (!candidateName || !position) {
                // ... existing validation code ...
            }
            
            // ... existing form submission code ...
        });

        // Pozisyon eşleşmesini ekranda görüntüle
        function displayPositionMatch(matchPercentage, matchingSkills, positionKeywords) {
            // Sonucu göster
            let matchHTML = `
                <div class="p-3 bg-white rounded-lg border border-purple-100">
                    <div class="flex items-center justify-between mb-2">
                        <p class="font-medium">Pozisyon Uyumu</p>
                        <div class="flex items-center">
                            <div class="w-24 h-3 bg-gray-200 rounded-full mr-2">
                                <div class="h-full rounded-full ${matchPercentage > 70 ? 'bg-green-500' : matchPercentage > 40 ? 'bg-yellow-500' : 'bg-red-500'}" 
                                    style="width: ${matchPercentage}%"></div>
                            </div>
                            <span class="text-sm font-medium ${matchPercentage > 70 ? 'text-green-700' : matchPercentage > 40 ? 'text-yellow-700' : 'text-red-700'}">
                                %${matchPercentage}
                            </span>
                        </div>
                    </div>
                    
                    <div class="text-sm">
                        <p>
                            <span class="font-medium">Eşleşen Beceriler:</span> 
                            ${matchingSkills.length > 0 ? matchingSkills.join(', ') : 'Pozisyona özel beceriler belirlenemedi.'}
                        </p>
                        
                        <p class="mt-1">
                            <span class="font-medium">Aranan Anahtar Kelimeler:</span> 
                            ${positionKeywords.join(', ')}
                        </p>
                        
                        <p class="mt-2 ${matchPercentage > 70 ? 'text-green-700' : matchPercentage > 40 ? 'text-yellow-700' : 'text-red-700'}">
                            <i class="fas ${matchPercentage > 70 ? 'fa-check-circle' : matchPercentage > 40 ? 'fa-info-circle' : 'fa-exclamation-circle'} mr-1"></i>
                            ${matchPercentage > 70 ? 
                                'Aday pozisyon için çok uygun görünüyor.' : 
                                matchPercentage > 40 ? 
                                'Aday pozisyon için potansiyel uygunlukta.' : 
                                'Aday pozisyon için uygunluğu düşük olabilir.'}
                        </p>
                    </div>
                </div>
            `;
            
            document.getElementById('matchAnalysis').innerHTML = matchHTML;
        }
    </script>
</body>
</html> 